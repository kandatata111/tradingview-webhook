<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€šè²¨å¼·å¼±ãƒ¡ãƒ¼ã‚¿ãƒ¼</title>
  <!-- Socket.IO CDN -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Meiryo, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 6px;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0;
    }

    h1 {
      text-align: center;
      color: #06b7f9;
      margin-bottom: 20px;
      font-size: 24px;
    }

    /* é€šè²¨å¼·å¼±è¡¨ */
    .strength-table {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 6px;
      border: 1px solid #444;
      margin-bottom: 0;
    }

    .strength-title {
      color: #06b7f9;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #06b7f9;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .strength-table-wrapper {
      width: 100%;
    }

    .strength-table-grid {
      display: grid;
      grid-template-columns: 50px repeat(5, 1fr) 2fr;
      gap: 2px;
      font-family: 'Consolas', monospace;
      font-size: 14px;
      font-weight: bold;
      width: 100%;
    }

    .table-header {
      font-weight: bold;
      background: #2d68f8;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4px;
      border: 1px solid #555;
      border-radius: 3px;
    }

    .table-header-currencies {
      font-weight: bold;
      background: #2d68f8;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4px;
      border: 1px solid #555;
      border-radius: 3px;
      grid-column: span 5;
    }

    .table-header-recommended {
      font-weight: bold;
      background: #2d68f8;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 4px;
      border: 1px solid #555;
      border-radius: 3px;
    }

    .table-row-label {
      font-weight: bold;
      background: #2d68f8;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border: 1px solid #555;
      padding: 4px;
      border-radius: 3px;
    }

    .table-cell {
      border: 1px solid #fff;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-radius: 3px;
      white-space: nowrap;
    }

    .table-cell.very-weak { background: #d32f2f; color: #fff; }
    .table-cell.weak { background: #f57c00; color: #fff; }
    .table-cell.neutral { background: #616161; color: #fff; }
    .table-cell.strong { background: #388e3c; color: #fff; }
    .table-cell.very-strong { background: #1976d2; color: #fff; }

    .table-recommended {
      border: 1px solid #555;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      flex-wrap: nowrap;
    }

    .recommended-pair {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 14px;
      white-space: nowrap;
    }

    .buy-badge {
      background: #1976d2;
      color: #fff;
      padding: 2px 5px;
      border-radius: 3px;
      font-weight: bold;
      font-size: 14px;
    }

    .sell-badge {
      background: #ff57ea;
      color: #fff;
      padding: 2px 5px;
      border-radius: 3px;
      font-weight: bold;
      font-size: 14px;
    }

    /* æ¨å¥¨ãƒšã‚¢ */
    .recommended {
      display: none;
    }

    /* é€šè²¨è‰²åˆ†ã‘ */
    .very-weak { background: #d32f2f; color: #fff; }
    .weak { background: #f57c00; color: #fff; }
    .neutral { background: #616161; color: #fff; }
    .strong { background: #388e3c; color: #fff; }
    .very-strong { background: #1976d2; color: #fff; }

    /* è¨­å®šé …ç›® */
    .settings-box {
      background: #2a2a2a;
      border: 2px solid #2d68f8;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
    }

    .settings-title {
      color: #2d68f8;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .settings-content {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      color: #e0e0e0;
    }

    .settings-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-group-title {
      color: #06b7f9;
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .checkbox-item input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
    }

    .checkbox-item label {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é€šè²¨å¼·å¼± + æ¨å¥¨ãƒšã‚¢ -->
    <div class="strength-table" id="strengthTableContainer" style="transform-origin: top left; transition: transform 0.2s ease;">
      <div class="strength-title">
        é€šè²¨å¼·å¼±ãƒ©ãƒ³ã‚­ãƒ³ã‚° + æ¨å¥¨ãƒšã‚¢ 
        <span id="loadingText" style="color:#ffd700;font-size:14px;margin-left:10px;">èª­ã¿è¾¼ã¿ä¸­...</span>
        <span id="updateTime" style="color:#fff;font-size:12px;margin-left:10px;"></span>
      </div>
      
      <div id="strengthData">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>

    <!-- è¨­å®šé …ç›® -->
    <div class="settings-box">
      <div class="settings-title">âš™ï¸ è¨­å®šé …ç›®</div>
      <div class="settings-content">
        <!-- ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ -->
        <div class="settings-group" style="border-left: 2px solid #ffd700; padding-left: 15px; margin-bottom: 12px;">
          <div class="settings-group-title">ğŸ” é€šè²¨å¼·å¼±è¡¨ã‚ºãƒ¼ãƒ </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <label style="font-size:12px;">è¡¨ç¤ºå€ç‡ï¼š</label>
            <select id="zoomLevel" style="padding:4px 6px;background:#333;color:#fff;border:1px solid #666;border-radius:3px;">
              <option value="50">50%</option>
              <option value="60">60%</option>
              <option value="70">70%</option>
              <option value="80">80%</option>
              <option value="90">90%</option>
              <option value="100" selected>100%</option>
              <option value="110">110%</option>
              <option value="120">120%</option>
              <option value="130">130%</option>
              <option value="140">140%</option>
              <option value="150">150%</option>
            </select>
          </div>
        </div>
        
        <div class="settings-group">
          <div class="settings-group-title">è¡¨ç¤ºé …ç›®</div>
          <div class="checkbox-item">
            <input type="checkbox" id="showCurrencies" checked>
            <label for="showCurrencies">é€šè²¨å¼·å¼±ã‚’è¡¨ç¤º</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="showRecommended" checked>
            <label for="showRecommended">æ¨å¥¨ãƒšã‚¢ã‚’è¡¨ç¤º</label>
          </div>
        </div>
        <div class="settings-group">
          <div class="settings-group-title">æ™‚é–“è¶³</div>
          <div class="checkbox-item">
            <input type="checkbox" id="show15m" checked>
            <label for="show15m">15mã‚’è¡¨ç¤º</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="show1H" checked>
            <label for="show1H">1Hã‚’è¡¨ç¤º</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="show4H" checked>
            <label for="show4H">4Hã‚’è¡¨ç¤º</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="showD" checked>
            <label for="showD">Dã‚’è¡¨ç¤º</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="showAv" checked>
            <label for="showAv">Avã‚’è¡¨ç¤º</label>
          </div>
        </div>
        
        <!-- éŸ³å£°é€šçŸ¥è¨­å®š -->
        <div class="settings-group" style="border-left: 2px solid #2d68f8; padding-left: 15px;">
          <div class="settings-group-title">ğŸ”Š æœ€å¼±ãƒ»æœ€å¼·å¤‰æ›´é€šçŸ¥</div>
          
          <div style="margin-bottom: 8px;">
            <label style="font-size:12px;">å£°å„ªé¸æŠï¼š</label>
            <select id="voiceActress" style="padding:4px 6px;background:#333;color:#fff;border:1px solid #666;border-radius:3px;">
              <option value="nanami">ä¸ƒæµ·ï¼ˆå¥³æ€§ï¼‰</option>
              <option value="keita">åœ­å¤ªï¼ˆç”·æ€§ï¼‰</option>
            </select>
          </div>
          
          <div style="margin-bottom: 8px;">
            <input type="checkbox" id="enableElectronic" style="width:16px;height:16px;cursor:pointer;">
            <label for="enableElectronic" style="cursor:pointer;">é›»å­éŸ³é¸æŠï¼š</label>
            <select id="electronicSound" style="padding:4px 6px;background:#333;color:#fff;border:1px solid #666;border-radius:3px;" disabled>
              <option value="buzzer">é–‹æ¼”ãƒ–ã‚¶ãƒ¼</option>
              <option value="bell">ãƒãƒ£ã‚¤ãƒ </option>
              <option value="notification">é€šçŸ¥éŸ³</option>
            </select>
          </div>
          
          <!-- å„æ™‚é–“è¶³ã®é€šçŸ¥è¨­å®š -->
          <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #555;">
            <div class="checkbox-item">
              <input type="checkbox" id="notify15m" checked>
              <label for="notify15m">15åˆ†ï¼š</label>
              <input type="text" id="msg15m" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="width:200px;padding:4px;background:#333;color:#fff;border:1px solid #666;border-radius:3px;margin:0 4px;">
              <button id="play15m" style="padding:4px 8px;background:#2d68f8;color:#fff;border:none;border-radius:3px;cursor:pointer;">å†ç”Ÿ</button>
            </div>
            
            <div class="checkbox-item">
              <input type="checkbox" id="notify1H" checked>
              <label for="notify1H">1æ™‚é–“ï¼š</label>
              <input type="text" id="msg1H" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="width:200px;padding:4px;background:#333;color:#fff;border:1px solid #666;border-radius:3px;margin:0 4px;">
              <button id="play1H" style="padding:4px 8px;background:#2d68f8;color:#fff;border:none;border-radius:3px;cursor:pointer;">å†ç”Ÿ</button>
            </div>
            
            <div class="checkbox-item">
              <input type="checkbox" id="notify4H" checked>
              <label for="notify4H">4æ™‚é–“ï¼š</label>
              <input type="text" id="msg4H" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="width:200px;padding:4px;background:#333;color:#fff;border:1px solid #666;border-radius:3px;margin:0 4px;">
              <button id="play4H" style="padding:4px 8px;background:#2d68f8;color:#fff;border:none;border-radius:3px;cursor:pointer;">å†ç”Ÿ</button>
            </div>
          </div>
          
          <!-- è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ -->
          <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #555;">
            <button id="saveSettings" style="padding:8px 20px;background:#28a745;color:#fff;border:none;border-radius:3px;cursor:pointer;font-weight:bold;width:100%;">
              ğŸ’¾ è¨­å®šã‚’ä¿å­˜
            </button>
            <div id="saveMessage" style="margin-top:6px;font-size:12px;text-align:center;color:#28a745;display:none;">âœ“ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è¨­å®šã®ä¿å­˜ã‚­ãƒ¼
    const STORAGE_KEY_VOICE_SETTINGS = 'currencyStrengthVoiceSettings';
    const STORAGE_KEY_ZOOM = 'currencyStrengthZoom';
    
    // è¨­å®šã‚’ä¿å­˜
    function saveSettings() {
      try {
        // éŸ³å£°é€šçŸ¥è¨­å®šã‚’ä¿å­˜
        const settings = {
          voiceActress: voiceNotificationSettings.voiceActress,
          enableElectronic: voiceNotificationSettings.enableElectronic,
          electronicSound: voiceNotificationSettings.electronicSound,
          notify: voiceNotificationSettings.notify,
          customMessages: voiceNotificationSettings.customMessages
        };
        localStorage.setItem(STORAGE_KEY_VOICE_SETTINGS, JSON.stringify(settings));
        
        // ã‚ºãƒ¼ãƒ è¨­å®šã‚’ä¿å­˜
        const zoomLevel = document.getElementById('zoomLevel').value;
        localStorage.setItem(STORAGE_KEY_ZOOM, zoomLevel);
        
        // ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const saveMsg = document.getElementById('saveMessage');
        saveMsg.style.display = 'block';
        setTimeout(() => {
          saveMsg.style.display = 'none';
        }, 2000);
        
        console.log('[SAVE] è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', settings, 'zoom:', zoomLevel);
      } catch (e) {
        console.error('[SAVE] è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', e);
        alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // è¨­å®šã‚’èª­ã¿è¾¼ã¿
    function loadSettings() {
      try {
        // éŸ³å£°é€šçŸ¥è¨­å®šã‚’èª­ã¿è¾¼ã¿
        const savedSettings = localStorage.getItem(STORAGE_KEY_VOICE_SETTINGS);
        if (savedSettings) {
          const settings = JSON.parse(savedSettings);
          console.log('[LOAD] ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿:', settings);
          
          // è¨­å®šã‚’å¾©å…ƒ
          document.getElementById('voiceActress').value = settings.voiceActress || 'nanami';
          voiceNotificationSettings.voiceActress = settings.voiceActress || 'nanami';
          
          document.getElementById('enableElectronic').checked = settings.enableElectronic || false;
          voiceNotificationSettings.enableElectronic = settings.enableElectronic || false;
          
          const soundSelect = document.getElementById('electronicSound');
          soundSelect.value = settings.electronicSound || '';
          soundSelect.disabled = !settings.enableElectronic;
          voiceNotificationSettings.electronicSound = settings.electronicSound || '';
          
          // å„æ™‚é–“è¶³ã®è¨­å®šã‚’å¾©å…ƒ
          ['15m', '1H', '4H'].forEach(tf => {
            if (settings.notify && settings.notify[tf] !== undefined) {
              document.getElementById(`notify${tf}`).checked = settings.notify[tf];
              voiceNotificationSettings.notify[tf] = settings.notify[tf];
            }
            if (settings.customMessages && settings.customMessages[tf]) {
              document.getElementById(`msg${tf}`).value = settings.customMessages[tf];
              voiceNotificationSettings.customMessages[tf] = settings.customMessages[tf];
            }
          });
        }
        
        // ã‚ºãƒ¼ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã¿
        const savedZoom = localStorage.getItem(STORAGE_KEY_ZOOM);
        if (savedZoom) {
          document.getElementById('zoomLevel').value = savedZoom;
          applyZoom(savedZoom);
          console.log('[LOAD] ã‚ºãƒ¼ãƒ è¨­å®šã‚’å¾©å…ƒ:', savedZoom + '%');
        }
      } catch (e) {
        console.error('[LOAD] è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
    }
    
    // ã‚ºãƒ¼ãƒ ã‚’é©ç”¨
    function applyZoom(level) {
      const container = document.getElementById('strengthTableContainer');
      if (container) {
        const scale = level / 100;
        container.style.transform = `scale(${scale})`;
        console.log('[ZOOM] ã‚ºãƒ¼ãƒ ã‚’é©ç”¨:', level + '%', 'scale:', scale);
      }
    }
    
    // Web Speech API ã®éŸ³å£°ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    let voicesLoaded = false;
    
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        voicesLoaded = true;
        console.log(`[VOICE_INIT] éŸ³å£°ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†: ${voices.length} voices`);
        // æ—¥æœ¬èªéŸ³å£°ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        const jaVoices = voices.filter(v => v.lang.startsWith('ja'));
        console.log(`[VOICE_INIT] æ—¥æœ¬èªéŸ³å£°æ•°: ${jaVoices.length}`);
        jaVoices.forEach((v, i) => {
          const actualIndex = voices.indexOf(v);
          console.log(`[VOICE_INIT]   [${actualIndex}] ${v.name} (${v.lang})`);
        });
      }
    }
    
    // éŸ³å£°ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices(); // å³åº§ã«è©¦è¡Œ
    
    // é›»å­éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
    async function populateChimeFiles() {
      const select = document.getElementById('electronicSound');
      console.log('[CHIME] Populating chime files...');
      try {
        const response = await fetch('/api/chime_files');
        if (response.ok) {
          const data = await response.json();
          console.log('[CHIME] Chime files response:', data);
          if (data.status === 'success' && data.files) {
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆã€Œãªã—ã€ä»¥å¤–ï¼‰
            select.innerHTML = '<option value="">ãªã—</option>';
            
            data.files.forEach(file => {
              const option = document.createElement('option');
              option.value = file;
              option.textContent = file.replace('.mp3', '').replace('.wav', '').replace('.ogg', '');
              select.appendChild(option);
            });
            console.log('[CHIME] Added', data.files.length, 'chime files to select');
          }
        }
      } catch (e) {
        console.error('[CHIME] Error fetching chime files:', e);
      }
    }
    
    // é›»å­éŸ³ã‚’å†ç”Ÿ
    function playChimeSound(onComplete) {
      if (!voiceNotificationSettings.enableElectronic || !voiceNotificationSettings.electronicSound) {
        console.log('[CHIME] Chime not enabled or file not set');
        if (onComplete) onComplete();
        return;
      }
      
      try {
        const audioPath = `/Alarm/${voiceNotificationSettings.electronicSound}`;
        console.log('[CHIME] Playing chime from:', audioPath);
        const audio = new Audio(audioPath);
        audio.volume = 0.8;
        
        audio.addEventListener('ended', () => {
          console.log('[CHIME] Chime playback completed');
          if (onComplete) onComplete();
        });
        
        audio.addEventListener('error', (err) => {
          console.error('[CHIME] Chime playback error:', err);
          if (onComplete) onComplete();
        });
        
        audio.play().then(() => {
          console.log('[CHIME] Chime playback started successfully');
        }).catch(err => {
          console.error('[CHIME] Failed to play chime:', err);
          if (onComplete) onComplete();
        });
      } catch (e) {
        console.error('[CHIME] Error playing chime:', e);
        if (onComplete) onComplete();
      }
    }
    
    // è¡¨ç¤ºè¨­å®š
    const displaySettings = {
      showCurrencies: true,
      showRecommended: true,
      show15m: true,
      show1H: true,
      show4H: true,
      showD: true,
      showAv: true
    };
    
    // éŸ³å£°é€šçŸ¥è¨­å®š
    const voiceNotificationSettings = {
      voiceActress: 'nanami',
      enableElectronic: false,
      electronicSound: '',
      notify: {
        '15m': true,
        '1H': true,
        '4H': true
      },
      customMessages: {
        '15m': '15åˆ†è¶³ã§æœ€å¼±ãƒ»æœ€å¼·ãŒå¤‰æ›´ã«ãªã‚Šã¾ã—ãŸ',
        '1H': '1æ™‚é–“è¶³ã§æœ€å¼±ãƒ»æœ€å¼·ãŒå¤‰æ›´ã«ãªã‚Šã¾ã—ãŸ',
        '4H': '4æ™‚é–“è¶³ã§æœ€å¼±ãƒ»æœ€å¼·ãŒå¤‰æ›´ã«ãªã‚Šã¾ã—ãŸ'
      }
    };
    
    // å‰å›ã®æœ€å¼±ãƒ»æœ€å¼·ã‚’ä¿å­˜
    let previousExtreme = {
      '15m': { weakest: null, strongest: null },
      '1H': { weakest: null, strongest: null },
      '4H': { weakest: null, strongest: null },
      'D': { weakest: null, strongest: null },
      'Av': { weakest: null, strongest: null }
    };
    
    // é›»å­éŸ³é¸æŠã®ãƒˆã‚°ãƒ«
    document.getElementById('enableElectronic').addEventListener('change', (e) => {
      voiceNotificationSettings.enableElectronic = e.target.checked;
      document.getElementById('electronicSound').disabled = !e.target.checked;
    });
    
    // å£°å„ªé¸æŠ
    document.getElementById('voiceActress').addEventListener('change', (e) => {
      voiceNotificationSettings.voiceActress = e.target.value;
    });
    
    // é›»å­éŸ³é¸æŠ
    document.getElementById('electronicSound').addEventListener('change', (e) => {
      voiceNotificationSettings.electronicSound = e.target.value;
    });
    
    // é€šçŸ¥æœ‰åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    ['15m', '1H', '4H'].forEach(tf => {
      const checkbox = document.getElementById(`notify${tf}`);
      if (checkbox) {
        checkbox.addEventListener('change', (e) => {
          voiceNotificationSettings.notify[tf] = e.target.checked;
        });
      }
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›
      const msgInput = document.getElementById(`msg${tf}`);
      if (msgInput) {
        msgInput.addEventListener('input', (e) => {
          voiceNotificationSettings.customMessages[tf] = e.target.value;
        });
      }
    });
    
    // å†ç”Ÿãƒœã‚¿ãƒ³ã®å‡¦ç†
    console.log('[VOICE_SETUP] Setting up play button listeners...');
    ['15m', '1H', '4H'].forEach(tf => {
      const playBtn = document.getElementById(`play${tf}`);
      console.log(`[VOICE_SETUP] play${tf} button:`, playBtn);
      if (playBtn) {
        playBtn.addEventListener('click', () => {
          console.log(`[VOICE_SETUP] Play button clicked for ${tf}`);
          const msgInput = document.getElementById(`msg${tf}`);
          const message = msgInput ? (msgInput.value || voiceNotificationSettings.customMessages[tf]) : `${tf}è¶³ã§æœ€å¼±ãƒ»æœ€å¼·ãŒå¤‰æ›´ã«ãªã‚Šã¾ã—ãŸ`;
          console.log(`[VOICE_SETUP] Message:`, message);
          playNotificationSound(tf, message);
        });
        console.log(`[VOICE_SETUP] âœ“ Listener attached to play${tf}`);
      } else {
        console.error(`[VOICE_SETUP] âœ— Button play${tf} not found!`);
      }
    });
    console.log('[VOICE_SETUP] Play button setup complete');
    
    // éŸ³å£°é€šçŸ¥ã‚’å†ç”Ÿï¼ˆWeb Speech API ã‚’ä½¿ç”¨ï¼‰
    function playNotificationSound(timeframe, message) {
      try {
        console.log(`[playNotificationSound] ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: timeframe=${timeframe}, message="${message}"`);
        
        // é›»å­éŸ³ã‚’å…ˆã«å†ç”Ÿã—ã€å®Œäº†å¾Œã«éŸ³å£°ã‚’ç™ºå£°
        playChimeSound(() => {
          console.log('[playNotificationSound] Chime completed, now playing voice');
          playVoiceMessage(message);
        });
        
      } catch (e) {
        console.error('[playNotificationSound] éŸ³å£°é€šçŸ¥ã‚¨ãƒ©ãƒ¼:', e);
        console.error('[playNotificationSound] Stack:', e.stack);
        alert('éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }
    
    // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†ç”Ÿ
    function playVoiceMessage(message) {
      try {
        // Web Speech API ã‚’ä½¿ç”¨
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'ja-JP';
        
        // å£°å„ªé¸æŠï¼ˆ369: ä¸ƒæµ·ï¼ˆå¥³æ€§ï¼‰, 370: åœ­å¤ªï¼ˆç”·æ€§ï¼‰ï¼‰
        const voiceIndex = voiceNotificationSettings.voiceActress === 'keita' ? 370 : 369;
        const voices = speechSynthesis.getVoices();
        
        console.log(`[playVoiceMessage] åˆ©ç”¨å¯èƒ½ãªéŸ³å£°æ•°: ${voices.length}`);
        console.log(`[playVoiceMessage] é¸æŠã•ã‚ŒãŸå£°å„ª: ${voiceNotificationSettings.voiceActress} (index: ${voiceIndex})`);
        
        if (voices.length > voiceIndex) {
          utterance.voice = voices[voiceIndex];
          console.log(`[playVoiceMessage] éŸ³å£°è¨­å®š: ${voices[voiceIndex].name}`);
        } else {
          console.warn(`[playVoiceMessage] æŒ‡å®šã•ã‚ŒãŸéŸ³å£°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
          // æ—¥æœ¬èªéŸ³å£°ã‚’æ¤œç´¢
          const jaVoice = voices.find(v => v.lang === 'ja-JP');
          if (jaVoice) {
            utterance.voice = jaVoice;
            console.log(`[playVoiceMessage] ä»£æ›¿éŸ³å£°: ${jaVoice.name}`);
          }
        }
        
        // éŸ³å£°åˆæˆã‚¤ãƒ™ãƒ³ãƒˆ
        utterance.onstart = () => {
          console.log(`[playVoiceMessage] âœ“ éŸ³å£°å†ç”Ÿé–‹å§‹`);
        };
        
        utterance.onend = () => {
          console.log(`[playVoiceMessage] âœ“ éŸ³å£°å†ç”Ÿå®Œäº†`);
        };
        
        utterance.onerror = (event) => {
          console.error(`[playVoiceMessage] éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:`, event.error);
        };
        
        // éŸ³å£°ã‚’å†ç”Ÿ
        speechSynthesis.speak(utterance);
        console.log(`[playVoiceMessage] speechSynthesis.speak() å‘¼ã³å‡ºã—å®Œäº†`);
        
      } catch (e) {
        console.error('[playVoiceMessage] ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.addEventListener('DOMContentLoaded', () => {
      ['showCurrencies', 'showRecommended', 'show15m', 'show1H', 'show4H', 'showD', 'showAv'].forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.addEventListener('change', (e) => {
            displaySettings[id] = e.target.checked;
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†æç”»
            if (window.currentData) {
              renderStrengthData(window.currentData);
            }
          });
        }
      });
    });
    // é€šè²¨ãƒšã‚¢ã®å®šç¾©ï¼ˆå®Ÿåœ¨ã™ã‚‹ãƒšã‚¢ã®ã¿ï¼‰
    const PAIR_DEFINITIONS = {
      'USDJPY': ['USD', 'JPY'],
      'EURUSD': ['EUR', 'USD'],
      'GBPUSD': ['GBP', 'USD'],
      'AUDUSD': ['AUD', 'USD'],
      'EURJPY': ['EUR', 'JPY'],
      'GBPJPY': ['GBP', 'JPY'],
      'AUDJPY': ['AUD', 'JPY'],
      'EURGBP': ['EUR', 'GBP'],
      'EURAUD': ['EUR', 'AUD'],
      'GBPAUD': ['GBP', 'AUD']
    };

    // é€šè²¨å¼·å¼±ã®è‰²åˆ†ã‘
    function getStrengthClass(score) {
      if (score <= -40) return 'very-weak';
      if (score <= -20) return 'weak';
      if (score <= 19) return 'neutral';
      if (score <= 39) return 'strong';
      return 'very-strong';
    }

    // æ¨å¥¨ãƒšã‚¢ã‚’è¨ˆç®—
    function calculateRecommendedPairs(currencies, rawScores) {
      const pairs = [];
      
      for (const [pair, [base, quote]] of Object.entries(PAIR_DEFINITIONS)) {
        const baseScore = rawScores[base] || 0;
        const quoteScore = rawScores[quote] || 0;
        const diff = Math.abs(baseScore - quoteScore);
        
        // å·®ãŒå°ã•ã„ï¼ˆãƒ¬ãƒ³ã‚¸ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (diff < 20) continue;
        
        let direction, displayPair;
        if (baseScore > quoteScore) {
          // ãƒ™ãƒ¼ã‚¹é€šè²¨ãŒå¼·ã„ = è²·ã„
          direction = 'buy';
          displayPair = pair;
        } else {
          // ã‚¯ã‚©ãƒ¼ãƒˆé€šè²¨ãŒå¼·ã„ = å£²ã‚Š
          direction = 'sell';
          displayPair = pair;
        }
        
        pairs.push({ pair: displayPair, direction, score: Math.round(diff) });
      }
      
      // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
      pairs.sort((a, b) => b.score - a.score);
      
      return pairs.slice(0, 3);  // ä¸Šä½3ã¤
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    function renderStrengthData(data) {
      try {
        console.log('[renderStrengthData] Starting render with data:', data);
        
        const container = document.getElementById('strengthData');
        if (!container) {
          console.error('[renderStrengthData] Container #strengthData not found!');
          return;
        }
        
        container.innerHTML = '';
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        const table = document.createElement('div');
        table.className = 'strength-table-wrapper';
        
        const grid = document.createElement('div');
        grid.className = 'strength-table-grid';
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        const headerTime = document.createElement('div');
        headerTime.className = 'table-header';
        headerTime.textContent = 'æ™‚é–“';
        grid.appendChild(headerTime);
        
        if (displaySettings.showCurrencies) {
          const headerCurrencies = document.createElement('div');
          headerCurrencies.className = 'table-header-currencies';
          headerCurrencies.textContent = 'å¼± â† ä¸­ â†’ å¼·';
          grid.appendChild(headerCurrencies);
        }
        
        if (displaySettings.showRecommended) {
          const headerRecommended = document.createElement('div');
          headerRecommended.className = 'table-header-recommended';
          headerRecommended.textContent = 'æ¨å¥¨ãƒšã‚¢';
          grid.appendChild(headerRecommended);
        }
        
        console.log('[renderStrengthData] Headers created');
        
        // ãƒ‡ãƒ¼ã‚¿è¡Œ
      const timeframes = [
        { key: '15m', id: 'show15m' },
        { key: '1H', id: 'show1H' },
        { key: '4H', id: 'show4H' },
        { key: 'D', id: 'showD' },
        { key: 'Av', id: 'showAv' }
      ];
      
      timeframes.forEach(tf => {
        if (!displaySettings[tf.id] || !data[tf.key]) return;
        
        const tfData = data[tf.key];
        const currencies = tfData.currencies; // ã™ã§ã«ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼ˆå¼±â†’å¼·ï¼‰
        const rawScores = tfData.raw_scores;
        const recommendedPairs = calculateRecommendedPairs(currencies, rawScores);
        
        // ğŸ”” å¤‰æ›´æ¤œå‡ºï¼šæœ€å¼±ã¨æœ€å¼·ã‚’ãƒã‚§ãƒƒã‚¯
        if (currencies && currencies.length > 0 && voiceNotificationSettings.notify[tf.key]) {
          const currentWeakest = currencies[0].currency;  // æœ€å¼±
          const currentStrongest = currencies[currencies.length - 1].currency;  // æœ€å¼·
          const prevState = previousExtreme[tf.key] || {};
          
          console.log(`[${tf.key}] é€šçŸ¥ãƒã‚§ãƒƒã‚¯: æœ€å¼±=${currentWeakest}, æœ€å¼·=${currentStrongest}`);
          
          // å‰å›ã®çŠ¶æ…‹ãŒãªã„å ´åˆã¯åˆæœŸåŒ–
          if (!prevState.weakest) {
            console.log(`[${tf.key}] åˆå›åˆæœŸåŒ–: weakest=${currentWeakest}, strongest=${currentStrongest}`);
            previousExtreme[tf.key] = {
              weakest: currentWeakest,
              strongest: currentStrongest
            };
          } else {
            // æœ€å¼±ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ã€æœ€å¼·ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ç¢ºèª
            const weakestChanged = prevState.weakest !== currentWeakest;
            const strongestChanged = prevState.strongest !== currentStrongest;
            
            console.log(`[${tf.key}] å¤‰æ›´æ¤œå‡º: weakest ${prevState.weakest}â†’${currentWeakest} (${weakestChanged}), strongest ${prevState.strongest}â†’${currentStrongest} (${strongestChanged})`);
            
            if (weakestChanged || strongestChanged) {
              // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦é€šçŸ¥ã‚’ç™ºç«
              let message = voiceNotificationSettings.customMessages[tf.key] || `${tf.key}ã®é€šè²¨å¼·å¼±ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚`;
              
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’å«ã‚ã¦ã„ãªã„ã‹ç¢ºèª
              if (message.includes('[WEAKEST]') || message.includes('[STRONGEST]')) {
                message = message
                  .replace('[WEAKEST]', currentWeakest)
                  .replace('[STRONGEST]', currentStrongest);
              }
              
              console.log(`[${tf.key}] ğŸ”” é€šçŸ¥ç™ºç«: "${message}"`);
              playNotificationSound(tf.key, message);
              
              // çŠ¶æ…‹ã‚’æ›´æ–°
              previousExtreme[tf.key] = {
                weakest: currentWeakest,
                strongest: currentStrongest
              };
            }
          }
        }
        
        // æ™‚é–“è¶³ãƒ©ãƒ™ãƒ«
        const labelCell = document.createElement('div');
        labelCell.className = 'table-row-label';
        labelCell.textContent = tf.key;
        grid.appendChild(labelCell);
        
        // é€šè²¨ã‚»ãƒ«ï¼ˆ5é€šè²¨ã€ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
        if (displaySettings.showCurrencies) {
          // é€šè²¨ã‚»ãƒ«ã‚’ã¾ã¨ã‚ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ5åˆ—åˆ†ï¼‰
          currencies.forEach((item, index) => {
            const cell = document.createElement('div');
            cell.className = 'table-cell ' + getStrengthClass(item.score);
            
            const percentage = item.percentage || 0;
            const percentText = percentage >= 0 ? `+${String(percentage).padStart(2, '0')}` : `-${String(Math.abs(percentage)).padStart(2, '0')}`;
            const scoreText = item.score >= 0 ? `+${String(item.score).padStart(3, '0')}` : `-${String(Math.abs(item.score)).padStart(3, '0')}`;
            
            cell.textContent = `${item.currency} ${percentText}% [${scoreText}]`;
            grid.appendChild(cell);
          });
        }
        
        // æ¨å¥¨ãƒšã‚¢ã‚»ãƒ«ï¼ˆ1è¡Œè¡¨ç¤ºï¼‰
        if (displaySettings.showRecommended) {
          const pairCell = document.createElement('div');
          pairCell.className = 'table-recommended';
        
        recommendedPairs.forEach(pairInfo => {
          const pairSpan = document.createElement('span');
          pairSpan.className = 'recommended-pair';
          
          const pairName = document.createElement('span');
          pairName.style.fontWeight = 'bold';
          pairName.style.color = '#fff';
          pairName.textContent = pairInfo.pair;
          pairSpan.appendChild(pairName);
          
          const dirBadge = document.createElement('span');
          dirBadge.className = pairInfo.direction === 'buy' ? 'buy-badge' : 'sell-badge';
          dirBadge.textContent = pairInfo.direction === 'buy' ? 'è²·â†‘' : 'å£²â†“';
          pairSpan.appendChild(dirBadge);
          
          const percentage = Math.round((pairInfo.score / 700.0) * 100);
          const percentText = percentage >= 0 ? `+${String(percentage).padStart(2, '0')}` : `-${String(Math.abs(percentage)).padStart(2, '0')}`;
          
          const scoreSpan = document.createElement('span');
          scoreSpan.style.color = '#ffd700';
          scoreSpan.style.fontWeight = 'bold';
          scoreSpan.textContent = `${percentText}%[${pairInfo.score}]`;
          pairSpan.appendChild(scoreSpan);
          
          pairCell.appendChild(pairSpan);
        });
        
        grid.appendChild(pairCell);
        }
      });
      
      // grid-template-columnsã‚’å‹•çš„ã«èª¿æ•´
      let columns = '50px'; // æ™‚é–“åˆ—
      if (displaySettings.showCurrencies && displaySettings.showRecommended) {
        // ä¸¡æ–¹è¡¨ç¤º: æ™‚é–“ + é€šè²¨5åˆ— + æ¨å¥¨ãƒšã‚¢
        columns += ' repeat(5, 1fr) 2fr';
      } else if (displaySettings.showCurrencies) {
        // é€šè²¨ã®ã¿: æ™‚é–“ + é€šè²¨5åˆ—
        columns += ' repeat(5, 1fr)';
      } else if (displaySettings.showRecommended) {
        // æ¨å¥¨ãƒšã‚¢ã®ã¿: æ™‚é–“ + æ¨å¥¨ãƒšã‚¢
        columns += ' 2fr';
      }
      grid.style.gridTemplateColumns = columns;
      
      console.log('[renderStrengthData] Grid template columns:', columns);
      
      table.appendChild(grid);
      container.appendChild(table);
      
      console.log('[renderStrengthData] Render complete. Container children:', container.children.length);
      
      } catch (error) {
        console.error('[renderStrengthData] ERROR during render:', error);
        console.error('[renderStrengthData] Stack trace:', error.stack);
        const container = document.getElementById('strengthData');
        if (container) {
          container.innerHTML = '<div style="color: red; padding: 20px;">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
        }
      }
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function loadCurrencyStrength() {
      try {
        document.getElementById('loadingText').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/currency_strength?_=${timestamp}`);
        const result = await response.json();
        
        if (result.status === 'success') {
          console.log('[CURRENCY_STRENGTH] Data received:', result.data);
          window.currentData = result.data; // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          renderStrengthData(result.data);
          
          // æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
          const now = new Date();
          const timeStr = now.toLocaleTimeString('ja-JP');
          document.getElementById('loadingText').textContent = 'âœ“ æ›´æ–°å®Œäº†';
          document.getElementById('updateTime').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;
          
          setTimeout(() => {
            document.getElementById('loadingText').textContent = '';
          }, 2000);
        } else {
          document.getElementById('loadingText').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + result.msg;
        }
      } catch (e) {
        console.error('[CURRENCY_STRENGTH] Error loading currency strength:', e);
        document.getElementById('loadingText').textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
      }
    }

    // Socket.IOæ¥ç¶šã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    const socket = io();
    
    socket.on('connect', () => {
      console.log('[SOCKET.IO] âœ“ Connected to server');
    });
    
    socket.on('disconnect', () => {
      console.log('[SOCKET.IO] âœ— Disconnected from server');
    });
    
    // Webhookå—ä¿¡æ™‚ã®é€šè²¨å¼·å¼±æ›´æ–°
    socket.on('currency_strength_update', (payload) => {
      console.log('[SOCKET.IO] Currency strength update received:', payload);
      
      if (payload.status === 'success' && payload.data) {
        window.currentData = payload.data;
        renderStrengthData(payload.data);
        
        // æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
        const updateTime = new Date(payload.timestamp);
        const timeStr = updateTime.toLocaleTimeString('ja-JP');
        document.getElementById('loadingText').textContent = 'âœ“ æ›´æ–°å®Œäº†';
        document.getElementById('updateTime').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;
        
        setTimeout(() => {
          document.getElementById('loadingText').textContent = '';
        }, 2000);
      }
    });
    
    // åˆæœŸåŒ–å‡¦ç†
    async function initCurrencyStrength() {
      console.log('[CURRENCY_STRENGTH] Initializing...');
      
      // é›»å­éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
      await populateChimeFiles();
      
      // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
      loadSettings();
      
      // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const saveBtn = document.getElementById('saveSettings');
      if (saveBtn) {
        saveBtn.addEventListener('click', saveSettings);
        console.log('[INIT] ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ');
      }
      
      // ã‚ºãƒ¼ãƒ ã‚»ãƒ¬ã‚¯ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const zoomSelect = document.getElementById('zoomLevel');
      if (zoomSelect) {
        zoomSelect.addEventListener('change', (e) => {
          applyZoom(e.target.value);
        });
        console.log('[INIT] ã‚ºãƒ¼ãƒ ã‚»ãƒ¬ã‚¯ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ');
      }
      
      // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãã®å¾Œã¯Socket.IOã§è‡ªå‹•æ›´æ–°ï¼‰
      loadCurrencyStrength();
      
      console.log('[INIT] åˆæœŸåŒ–å®Œäº† - ä»¥é™ã¯Webhookå—ä¿¡æ™‚ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™');
    }
    
    // åˆå›èª­ã¿è¾¼ã¿
    initCurrencyStrength();
  </script>
</body>
</html>
