<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Test Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: var(--input-padding, 8px);
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: var(--font-size, 14px);
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .radio-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: var(--button-padding-vertical, 10px) var(--button-padding-horizontal, 20px);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: var(--font-size, 14px);
        }
        button:hover {
            background-color: #45a049;
        }
        .json-output {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            font-size: var(--font-size, 14px);
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        table {
            width: auto;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: var(--font-size, 14px);
        }
        th, td {
            border: 1px solid #ddd;
            padding: var(--padding-vertical, 4px) var(--padding-horizontal, 6px);
            text-align: center;
            font-size: inherit;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        /* æ•´åˆ—é›²ãƒ»æ™‚é–“å·®: æ¨ªã«ä¸¦ã¹ã‚‹ */
        .tf-label {
            font-weight: bold;
            cursor: grab;
            padding: 2px 4px;
        }
        .tf-label:active {
            cursor: grabbing;
        }
        .time-diff {
            padding: 2px 4px;
            white-space: nowrap;
        }
        /* ãƒ€ã‚¦è»¢ãƒ»çªç ´æ•°ãƒ»é›²äº¤å·®: æœ€å°é™ã®å¹… */
        .editable {
            cursor: pointer;
            min-width: unset;
            padding: 2px 5px;
            white-space: nowrap;
        }
        /* å„é›²é–“ãƒ»ä¾¡æ ¼é–“ãƒ»é›²è§’åº¦ãƒ»é›²åšã¿: æœ€å°é™ã®å¹… */
        td input[type="number"] {
            width: 50px;
            padding: 2px;
            text-align: center;
        }
        /* ãƒ€ã‚¦æ™‚é–“ãƒ»äº¤å·®æ™‚é–“: æ™‚é–“å…¥åŠ›ç”¨ */
        td input[type="text"] {
            width: 100px;
            padding: 2px;
            text-align: center;
        }
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¹…ã‚’å†…å®¹ã«åˆã‚ã›ã‚‹ */
        th:nth-child(1) { padding: 2px 4px; } /* æ•´åˆ—é›² */
        th:nth-child(2), th:nth-child(3), th:nth-child(4) { padding: 2px 5px; } /* ãƒ€ã‚¦è»¢ãƒ»çªç ´æ•°ãƒ»é›²äº¤å·® */
        th:nth-child(5), th:nth-child(6), th:nth-child(7), th:nth-child(8) { padding: 2px 5px; } /* å„é›²é–“ãƒ»ä¾¡æ ¼é–“ãƒ»é›²è§’åº¦ãƒ»é›²åšã¿ */
        th:nth-child(11) { padding: 2px 4px; } /* æ™‚é–“å·® */
        .blue-bg {
            background-color: #2962ff;
            color: white;
        }
        .red-bg {
            background-color: #f23645;
            color: white;
        }
        .time-display-toggle {
            margin-bottom: 10px;
        }
        .time-display-toggle button {
            margin-right: 5px;
        }
        /* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆé ˜åŸŸ */
        .json-paste-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            background-color: #f9fff9;
        }
        .json-paste-section label {
            color: #2e7d32;
            font-size: 16px;
        }
        .json-paste-section textarea.paste-textarea {
            width: 100%;
            height: 120px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
            margin-top: 10px;
        }
        .json-paste-section .btn-group {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .json-paste-section button.apply-btn {
            background-color: #4CAF50;
        }
        .json-paste-section button.apply-btn:hover {
            background-color: #45a049;
        }
        .json-paste-section button.direct-send-btn {
            background-color: #4CAF50;
        }
        .json-paste-section button.direct-send-btn:hover {
            background-color: #45a049;
        }
        .json-paste-section button.clear-btn {
            background-color: #4CAF50;
        }
        .json-paste-section button.clear-btn:hover {
            background-color: #45a049;
        }
        .json-paste-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
            font-size: var(--font-size, 14px);
        }
        .json-paste-status.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        .json-paste-status.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>JSON Test Panel</h1>
        
        <div class="form-group">
            <label for="symbol">Symbol:</label>
            <select id="symbol">
                <option value="USDJPY">USDJPY</option>
                <option value="EURUSD">EURUSD</option>
                <option value="GBPUSD">GBPUSD</option>
                <option value="GBPJPY">GBPJPY</option>
                <option value="AUDUSD">AUDUSD</option>
                <option value="AUDJPY">AUDJPY</option>
                <option value="NZDUSD">NZDUSD</option>
                <option value="NZDJPY">NZDJPY</option>
                <option value="CADJPY">CADJPY</option>
                <option value="CHFJPY">CHFJPY</option>
                <option value="EURJPY">EURJPY</option>
                <option value="GBPAUD">GBPAUD</option>
                <option value="EURGBP">EURGBP</option>
                <option value="USDCAD">USDCAD</option>
                <option value="USDCHF">USDCHF</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="price">Price:</label>
            <input type="number" id="price" step="0.01" value="150.00" required>
        </div>
        
        <div class="form-group">
            <label for="fontSize">æ–‡å­—ã‚µã‚¤ã‚º:</label>
            <select id="fontSize" onchange="changeFontSize(this.value)">
                <option value="10">10px</option>
                <option value="11">11px</option>
                <option value="12">12px</option>
                <option value="13">13px</option>
                <option value="14">14px</option>
                <option value="15">15px</option>
                <option value="16">16px</option>
                <option value="17">17px</option>
                <option value="18">18px</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="saveName">ä¿å­˜åç§°:</label>
            <input type="text" id="saveName" placeholder="ä¿å­˜ã™ã‚‹åç§°ã‚’å…¥åŠ›">
            <button onclick="saveData()">ä¿å­˜</button>
            <button onclick="loadData()">èª­ã¿è¾¼ã¿</button>
            <select id="loadSelect" onchange="loadSelectedData(this.value)">
                <option value="">-- é¸æŠ --</option>
            </select>
            <button onclick="deleteData()">å‰Šé™¤</button>
            <button onclick="renameData()">åç§°å¤‰æ›´</button>
        </div>
        
        <div class="time-display-toggle">
            <label>æ™‚é–“è¡¨ç¤ºå½¢å¼:</label>
            <button onclick="setTimeFormat('dhm')">æ—¥/æ™‚/åˆ† (DD/HH:mm)</button>
            <button onclick="setTimeFormat('hm')">æ™‚/åˆ† (HH:mm)</button>
            <button onclick="setTimeFormat('m')">åˆ†ã®ã¿ (mm)</button>
            <button onclick="setTimeFormat('original')">æ¸¬å®šé–‹å§‹æ—¥æ™‚</button>
        </div>
        
        <!-- ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆé ˜åŸŸï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
        <div class="json-paste-section">
            <div style="margin-bottom: 10px;">
                <label>ğŸ“¥ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆ:</label>
                <button onclick="switchPasteJsonView('5m')" style="padding: 8px 16px; margin-left: 10px; background-color: #a9e88c; color: #000;">5m</button>
                <button onclick="switchPasteJsonView('15m')" style="padding: 8px 16px; margin-left: 5px; background-color: #fbd0b2; color: #000;">15m</button>
                <button onclick="switchPasteJsonView('1H')" style="padding: 8px 16px; margin-left: 5px; background-color: #8dc7fc; color: #000;">1H</button>
                <button onclick="switchPasteJsonView('4H')" style="padding: 8px 16px; margin-left: 5px; background-color: #fa8dfe; color: #000;">4H</button>
            </div>
            <textarea id="indicatorJsonPaste5m" class="paste-textarea" placeholder="5mç”¨JSONã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ..."></textarea>
            <textarea id="indicatorJsonPaste15m" class="paste-textarea" style="display: none;" placeholder="15mç”¨JSONã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ..."></textarea>
            <textarea id="indicatorJsonPaste1H" class="paste-textarea" style="display: none;" placeholder="1Hç”¨JSONã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ..."></textarea>
            <textarea id="indicatorJsonPaste4H" class="paste-textarea" style="display: none;" placeholder="4Hç”¨JSONã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ..."></textarea>
            <div class="btn-group" style="align-items: center;">
                <button class="apply-btn" onclick="applyPastedJsonToTable()">è¡¨ã«åæ˜ </button>
                <button class="direct-send-btn" onclick="directSendPastedJson()">ç›´æ¥é€ä¿¡</button>
                <button class="clear-btn" onclick="clearPastedJson()">ã‚¯ãƒªã‚¢</button>
                <label style="margin-left: 20px; font-weight: normal; display: inline-flex; align-items: center;"><input type="radio" name="paste_tf" value="5m" checked style="margin-right: 2px;"><span style="font-size: var(--font-size, 14px);">5m</span></label>
                <label style="margin-left: 10px; font-weight: normal; display: inline-flex; align-items: center;"><input type="radio" name="paste_tf" value="15m" style="margin-right: 2px;"><span style="font-size: var(--font-size, 14px);">15m</span></label>
                <label style="margin-left: 10px; font-weight: normal; display: inline-flex; align-items: center;"><input type="radio" name="paste_tf" value="1H" style="margin-right: 2px;"><span style="font-size: var(--font-size, 14px);">1H</span></label>
                <label style="margin-left: 10px; font-weight: normal; display: inline-flex; align-items: center;"><input type="radio" name="paste_tf" value="4H" style="margin-right: 2px;"><span style="font-size: var(--font-size, 14px);">4H</span></label>
            </div>
            <div id="jsonPasteStatus" class="json-paste-status"></div>
        </div>
        
        <table id="dataTable">
            <thead>
                <tr>
                    <th>æ•´åˆ—é›²</th>
                    <th>ãƒ€ã‚¦è»¢</th>
                    <th>çªç ´æ•°</th>
                    <th>é›²äº¤å·®</th>
                    <th>å„é›²é–“</th>
                    <th>ä¾¡æ ¼é–“</th>
                    <th>é›²è§’åº¦</th>
                    <th>é›²åšã¿</th>
                    <th>ãƒ€ã‚¦æ™‚é–“</th>
                    <th>äº¤å·®æ™‚é–“</th>
                    <th>æ™‚é–“å·®</th>
                </tr>
            </thead>
            <tbody>
                <tr data-tf="5m">
                    <td class="tf-label" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)" style="background-color: #a9e88c;">5m</td>
                    <td class="editable" onclick="toggleDauten(this)" data-value="up">â–²Dow</td>
                    <td class="editable" onclick="cycleBos(this)" oncontextmenu="cycleBosReverse(this); return false;" data-value="-">-</td>
                    <td class="editable" onclick="toggleGc(this)" data-value="true">â–²GC</td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_prev"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_price"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="angle"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="thickness"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="dauten_start_time_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="elapsed_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td class="time-diff">-</td>
                </tr>
                <tr data-tf="15m">
                    <td class="tf-label" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)" style="background-color: #fbd0b2;">15m</td>
                    <td class="editable" onclick="toggleDauten(this)" data-value="down">â–¼Dow</td>
                    <td class="editable" onclick="cycleBos(this)" oncontextmenu="cycleBosReverse(this); return false;" data-value="-">-</td>
                    <td class="editable" onclick="toggleGc(this)" data-value="false">â–¼DC</td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_prev"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_price"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="angle"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="thickness"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="dauten_start_time_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="elapsed_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td class="time-diff">-</td>
                </tr>
                <tr data-tf="1H">
                    <td class="tf-label" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)" style="background-color: #8dc7fc;">1H</td>
                    <td class="editable" onclick="toggleDauten(this)" data-value="up">â–²Dow</td>
                    <td class="editable" onclick="cycleBos(this)" oncontextmenu="cycleBosReverse(this); return false;" data-value="-">-</td>
                    <td class="editable" onclick="toggleGc(this)" data-value="true">â–²GC</td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_prev"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_price"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="angle"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="thickness"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="dauten_start_time_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="elapsed_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td class="time-diff">-</td>
                </tr>
                <tr data-tf="4H">
                    <td class="tf-label" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)" style="background-color: #fa8dfe;">4H</td>
                    <td class="editable" onclick="toggleDauten(this)" data-value="down">â–¼Dow</td>
                    <td class="editable" onclick="cycleBos(this)" oncontextmenu="cycleBosReverse(this); return false;" data-value="-">-</td>
                    <td class="editable" onclick="toggleGc(this)" data-value="false">â–¼DC</td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_prev"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="distance_from_price"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="angle"></td>
                    <td><input type="number" step="0.1" onchange="updateNumericBg(this)" data-field="thickness"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="dauten_start_time_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td><input type="text" onchange="updateTimeBg(this)" data-field="elapsed_str" placeholder="YY/MM/DD/HH:mm"></td>
                    <td class="time-diff">-</td>
                </tr>
                <tr data-tf="price">
                    <td class="tf-label" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event)">ä¾¡æ ¼</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
        
        <div class="radio-group">
            <label>
                <input type="radio" name="target" value="test" checked> ãƒ†ã‚¹ãƒˆç”¨ (localhost:5000)
            </label>
            <label>
                <input type="radio" name="target" value="production"> æœ¬ç•ªç”¨ (Render)
            </label>
        </div>
        
        <div class="radio-group">
            <label style="font-weight: bold;">ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠ:</label><br>
            <label>
                <input type="radio" name="selected_tf" value="5m" checked> 5m
            </label>
            <label>
                <input type="radio" name="selected_tf" value="15m"> 15m
            </label>
            <label>
                <input type="radio" name="selected_tf" value="1H"> 1H
            </label>
            <label>
                <input type="radio" name="selected_tf" value="4H"> 4H
            </label>
        </div>
        
        <button onclick="generateJson()">JSONç”Ÿæˆ</button>
        <button onclick="sendJson()">é€ä¿¡</button>
        
        <div style="margin-top: 20px; margin-bottom: 10px;">
            <div style="margin-bottom: 10px;">
                <label style="font-weight: bold;">JSONè¡¨ç¤º:</label>
                <button onclick="switchJsonView('5m')" style="padding: 8px 16px; margin-right: 5px; background-color: #a9e88c; color: #000;">5m</button>
                <button onclick="switchJsonView('15m')" style="padding: 8px 16px; margin-right: 5px; background-color: #fbd0b2; color: #000;">15m</button>
                <button onclick="switchJsonView('1H')" style="padding: 8px 16px; margin-right: 5px; background-color: #8dc7fc; color: #000;">1H</button>
                <button onclick="switchJsonView('4H')" style="padding: 8px 16px; background-color: #fa8dfe; color: #000;">4H</button>
            </div>
        </div>
        
        <div class="json-output" id="jsonOutput5m" style="display: none;"></div>
        <div class="json-output" id="jsonOutput15m" style="display: none;"></div>
        <div class="json-output" id="jsonOutput1H" style="display: none;"></div>
        <div class="json-output" id="jsonOutput4H" style="display: none;"></div>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        let timeFormat = 'original'; // 'original', 'dhm', 'hm', 'm'
        let originalTimeData = {}; // å…ƒã®æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜

        function changeFontSize(size) {
            const root = document.documentElement;
            root.style.setProperty('--font-size', size + 'px');
            root.style.setProperty('--padding-vertical', (size * 0.3) + 'px');
            root.style.setProperty('--padding-horizontal', (size * 0.4) + 'px');
            root.style.setProperty('--input-padding', (size * 0.5) + 'px');
            root.style.setProperty('--button-padding-vertical', (size * 0.7) + 'px');
            root.style.setProperty('--button-padding-horizontal', (size * 1.4) + 'px');
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        let draggedRow = null;

        function dragStart(event) {
            draggedRow = event.target.closest('tr');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', '');
            event.target.style.opacity = '0.5';
        }

        function dragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const targetRow = event.target.closest('tr');
            if (targetRow && targetRow !== draggedRow) {
                targetRow.style.borderTop = '2px solid #007bff';
            }
        }

        function drop(event) {
            event.preventDefault();
            const targetRow = event.target.closest('tr');
            
            // å¢ƒç•Œç·šã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                row.style.borderTop = '';
            });
            
            if (targetRow && targetRow !== draggedRow) {
                const tbody = draggedRow.parentNode;
                const draggedIndex = Array.from(tbody.children).indexOf(draggedRow);
                const targetIndex = Array.from(tbody.children).indexOf(targetRow);
                
                if (draggedIndex < targetIndex) {
                    tbody.insertBefore(draggedRow, targetRow.nextSibling);
                } else {
                    tbody.insertBefore(draggedRow, targetRow);
                }
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (draggedRow) {
                draggedRow.querySelector('.tf-label').style.opacity = '';
            }
            draggedRow = null;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†
        document.addEventListener('dragend', function(event) {
            // å¢ƒç•Œç·šã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                row.style.borderTop = '';
            });
            
            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (event.target.classList.contains('tf-label')) {
                event.target.style.opacity = '';
            }
        });

        function saveData() {
            console.log('saveData() called');
            const saveName = document.getElementById('saveName').value.trim();
            console.log('saveName:', saveName);
            if (!saveName) {
                alert('ä¿å­˜åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                symbol: document.getElementById('symbol').value,
                price: document.getElementById('price').value,
                fontSize: document.getElementById('fontSize').value,
                timeFormat: timeFormat,
                originalTimeData: originalTimeData,
                rowOrder: Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => row.getAttribute('data-tf')),
                tableData: {},
                // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                pastedJson: {
                    '5m': document.getElementById('indicatorJsonPaste5m').value,
                    '15m': document.getElementById('indicatorJsonPaste15m').value,
                    '1H': document.getElementById('indicatorJsonPaste1H').value,
                    '4H': document.getElementById('indicatorJsonPaste4H').value
                }
            };

            console.log('data before table collection:', data);

            // è¡¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const rows = document.querySelectorAll('#dataTable tbody tr');
            console.log('total rows found:', rows.length);
            
            rows.forEach((row, index) => {
                const tf = row.getAttribute('data-tf');
                console.log(`row ${index}: tf=${tf}`);
                
                // ä¾¡æ ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                if (tf === 'price') {
                    console.log(`skipping price row at index ${index}`);
                    return;
                }
                
                try {
                    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã§ã‚»ãƒ«ã‚’å–å¾—ï¼ˆã‚ˆã‚Šç¢ºå®Ÿï¼‰
                    const cells = row.querySelectorAll('td');
                    console.log(`row ${index} (${tf}) has ${cells.length} cells`);
                    
                    // ã‚»ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 0=TF, 1=ãƒ€ã‚¦è»¢, 2=çªç ´æ•°, 3=é›²äº¤å·®, 4-10=æ•°å€¤, 11=æ™‚é–“å·®
                    const dautenCell = cells[1];  // ãƒ€ã‚¦è»¢
                    const bosCell = cells[2];     // çªç ´æ•°
                    const gcCell = cells[3];      // é›²äº¤å·®
                    
                    const inputs = row.querySelectorAll('input');
                    
                    data.tableData[tf] = {
                        dauten: dautenCell?.getAttribute('data-value') || 'up',
                        bos: bosCell?.getAttribute('data-value') || '-',
                        gc: gcCell?.getAttribute('data-value') || 'true',
                        distance_from_prev: inputs[0]?.value || '',
                        distance_from_price: inputs[1]?.value || '',
                        angle: inputs[2]?.value || '',
                        thickness: inputs[3]?.value || '',
                        dauten_start_time_str: inputs[4]?.value || '',
                        elapsed_str: inputs[5]?.value || ''
                    };
                    console.log(`tableData for ${tf}:`, data.tableData[tf]);
                } catch (e) {
                    console.error(`Error processing row ${index} (${tf}):`, e);
                }
            });

            console.log('data after table collection:', data);

            try {
                // localStorageã«ä¿å­˜
                const savedData = JSON.parse(localStorage.getItem('jsonTestPanelSaves') || '{}');
                console.log('existing savedData:', savedData);
                savedData[saveName] = data;
                localStorage.setItem('jsonTestPanelSaves', JSON.stringify(savedData));
                console.log('saved to localStorage:', saveName);
                console.log('localStorage contents:', localStorage.getItem('jsonTestPanelSaves'));

                // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                updateLoadSelect();
                
                // ä¿å­˜ã—ãŸåç§°ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é¸æŠ
                document.getElementById('loadSelect').value = saveName;
                
                // ä¿å­˜åç§°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('saveName').value = '';
                
                alert('ä¿å­˜ã—ã¾ã—ãŸ: ' + saveName);
            } catch (error) {
                console.error('Save error:', error);
                alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        function loadData() {
            const saveName = document.getElementById('saveName').value.trim();
            if (!saveName) {
                alert('èª­ã¿è¾¼ã¿åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            loadSelectedData(saveName);
        }

        function loadSelectedData(saveName) {
            if (!saveName) return;

            const savedData = JSON.parse(localStorage.getItem('jsonTestPanelSaves') || '{}');
            const data = savedData[saveName];
            if (!data) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ä¿å­˜åç§°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
            document.getElementById('saveName').value = saveName;

            // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            document.getElementById('symbol').value = data.symbol || '';
            document.getElementById('price').value = data.price || '';
            document.getElementById('fontSize').value = data.fontSize || '14';
            changeFontSize(data.fontSize || '14');
            timeFormat = data.timeFormat || 'original';
            originalTimeData = data.originalTimeData || {};
            
            // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            if (data.pastedJson) {
                document.getElementById('indicatorJsonPaste5m').value = data.pastedJson['5m'] || '';
                document.getElementById('indicatorJsonPaste15m').value = data.pastedJson['15m'] || '';
                document.getElementById('indicatorJsonPaste1H').value = data.pastedJson['1H'] || '';
                document.getElementById('indicatorJsonPaste4H').value = data.pastedJson['4H'] || '';
            }

            // è¡¨ã®é †åºã‚’å¾©å…ƒ
            if (data.rowOrder) {
                const tbody = document.querySelector('#dataTable tbody');
                const rows = Array.from(tbody.children);
                
                // ç¾åœ¨ã®é †åºã«åŸºã¥ã„ã¦è¡Œã‚’ä¸¦ã¹æ›¿ãˆ
                data.rowOrder.forEach(tf => {
                    const row = rows.find(r => r.getAttribute('data-tf') === tf);
                    if (row) {
                        tbody.appendChild(row);
                    }
                });
            }

            // è¡¨ã®é †åºã‚’å¾©å…ƒ
            if (data.rowOrder) {
                const tbody = document.querySelector('#dataTable tbody');
                const rows = Array.from(tbody.children);
                
                // ç¾åœ¨ã®é †åºã«åŸºã¥ã„ã¦è¡Œã‚’ä¸¦ã¹æ›¿ãˆ
                data.rowOrder.forEach(tf => {
                    const row = rows.find(r => r.getAttribute('data-tf') === tf);
                    if (row) {
                        tbody.appendChild(row);
                    }
                });
            }

            // è¡¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const tf = row.getAttribute('data-tf');
                const rowData = data.tableData[tf];
                if (rowData) {
                    row.querySelector('td[data-value]').setAttribute('data-value', rowData.dauten);
                    row.querySelector('td[data-value]').textContent = rowData.dauten === 'up' ? 'â–²Dow' : 'â–¼Dow';
                    row.querySelector('td[onclick*="cycleBos"]').setAttribute('data-value', rowData.bos);
                    row.querySelector('td[onclick*="cycleBos"]').textContent = rowData.bos;
                    row.querySelector('td[onclick*="toggleGc"]').setAttribute('data-value', rowData.gc);
                    row.querySelector('td[onclick*="toggleGc"]').textContent = rowData.gc === 'true' ? 'â–²GC' : 'â–¼DC';
                    row.querySelector('input[data-field="distance_from_prev"]').value = rowData.distance_from_prev || '';
                    row.querySelector('input[data-field="distance_from_price"]').value = rowData.distance_from_price || '';
                    row.querySelector('input[data-field="angle"]').value = rowData.angle || '';
                    row.querySelector('input[data-field="thickness"]').value = rowData.thickness || '';
                    row.querySelector('input[data-field="dauten_start_time_str"]').value = rowData.dauten_start_time_str || '';
                    row.querySelector('input[data-field="elapsed_str"]').value = rowData.elapsed_str || '';
                }
            });

            // èƒŒæ™¯è‰²ã¨è¨ˆç®—ã‚’æ›´æ–°
            document.querySelectorAll('td[data-value]').forEach(cell => {
                cell.classList.remove('blue-bg', 'red-bg');
                if (cell.getAttribute('data-value') === 'up' || cell.getAttribute('data-value') === 'true') {
                    cell.classList.add('blue-bg');
                } else if (cell.getAttribute('data-value') === 'down' || cell.getAttribute('data-value') === 'false') {
                    cell.classList.add('red-bg');
                }
            });

            document.querySelectorAll('td[onclick*="cycleBos"]').forEach(cell => {
                updateBosBg(cell);
            });

            document.querySelectorAll('input[data-field]').forEach(input => {
                if (input.type === 'number') {
                    updateNumericBg(input);
                } else if (input.getAttribute('data-field').includes('time')) {
                    updateTimeBg(input);
                }
            });

            updateAllTimeDisplays();
            alert('èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ' + saveName);
        }

        function updateLoadSelect() {
            const select = document.getElementById('loadSelect');
            select.innerHTML = '<option value="">-- é¸æŠ --</option>';
            const savedData = JSON.parse(localStorage.getItem('jsonTestPanelSaves') || '{}');
            Object.keys(savedData).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function deleteData() {
            const select = document.getElementById('loadSelect');
            const selectedName = select.value;
            if (!selectedName) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`"${selectedName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const savedData = JSON.parse(localStorage.getItem('jsonTestPanelSaves') || '{}');
            delete savedData[selectedName];
            localStorage.setItem('jsonTestPanelSaves', JSON.stringify(savedData));
            
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateLoadSelect();
            
            // ä¿å­˜åç§°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‰Šé™¤ã—ãŸã‚‚ã®ã¨åŒã˜ãªã‚‰ã‚¯ãƒªã‚¢
            if (document.getElementById('saveName').value === selectedName) {
                document.getElementById('saveName').value = '';
            }
            
            alert('å‰Šé™¤ã—ã¾ã—ãŸ: ' + selectedName);
        }

        function renameData() {
            const select = document.getElementById('loadSelect');
            const oldName = select.value;
            if (!oldName) {
                alert('åç§°å¤‰æ›´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const newName = prompt('æ–°ã—ã„åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', oldName);
            if (!newName || newName.trim() === '') {
                return;
            }
            
            const trimmedNewName = newName.trim();
            if (trimmedNewName === oldName) {
                return; // åŒã˜åç§°ãªã‚‰ä½•ã‚‚ã—ãªã„
            }
            
            const savedData = JSON.parse(localStorage.getItem('jsonTestPanelSaves') || '{}');
            if (savedData[trimmedNewName]) {
                alert('ãã®åç§°ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }
            
            savedData[trimmedNewName] = savedData[oldName];
            delete savedData[oldName];
            localStorage.setItem('jsonTestPanelSaves', JSON.stringify(savedData));
            
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateLoadSelect();
            
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ–°ã—ã„åç§°ã«é¸æŠ
            select.value = trimmedNewName;
            
            // ä¿å­˜åç§°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            document.getElementById('saveName').value = trimmedNewName;
            
            alert('åç§°ã‚’å¤‰æ›´ã—ã¾ã—ãŸ: ' + oldName + ' â†’ ' + trimmedNewName);
        }

        function autoSave() {
            const data = {
                symbol: document.getElementById('symbol').value,
                price: document.getElementById('price').value,
                fontSize: document.getElementById('fontSize').value,
                timeFormat: timeFormat,
                originalTimeData: originalTimeData,
                rowOrder: Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => row.getAttribute('data-tf')),
                tableData: {}
            };

            // è¡¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const tf = row.getAttribute('data-tf');
                data.tableData[tf] = {
                    dauten: row.querySelector('td[data-value]').getAttribute('data-value'),
                    bos: row.querySelector('td[onclick*="cycleBos"]').getAttribute('data-value'),
                    gc: row.querySelector('td[onclick*="toggleGc"]').getAttribute('data-value'),
                    distance_from_prev: row.querySelector('input[data-field="distance_from_prev"]').value,
                    distance_from_price: row.querySelector('input[data-field="distance_from_price"]').value,
                    angle: row.querySelector('input[data-field="angle"]').value,
                    thickness: row.querySelector('input[data-field="thickness"]').value,
                    dauten_start_time_str: row.querySelector('input[data-field="dauten_start_time_str"]').value,
                    elapsed_str: row.querySelector('input[data-field="elapsed_str"]').value
                };
            });

            localStorage.setItem('jsonTestPanelAutoSave', JSON.stringify(data));
        }

        function loadAutoSave() {
            const data = JSON.parse(localStorage.getItem('jsonTestPanelAutoSave') || 'null');
            if (data) {
                document.getElementById('symbol').value = data.symbol || '';
                document.getElementById('price').value = data.price || '';
                document.getElementById('fontSize').value = data.fontSize || '14';
                changeFontSize(data.fontSize || '14');
                timeFormat = data.timeFormat || 'original';
                originalTimeData = data.originalTimeData || {};

                // è¡¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                    const tf = row.getAttribute('data-tf');
                    const rowData = data.tableData[tf];
                    if (rowData) {
                        row.querySelector('td[data-value]').setAttribute('data-value', rowData.dauten);
                        row.querySelector('td[data-value]').textContent = rowData.dauten === 'up' ? 'â–²Dow' : 'â–¼Dow';
                        row.querySelector('td[onclick*="cycleBos"]').setAttribute('data-value', rowData.bos);
                        row.querySelector('td[onclick*="cycleBos"]').textContent = rowData.bos;
                        row.querySelector('td[onclick*="toggleGc"]').setAttribute('data-value', rowData.gc);
                        row.querySelector('td[onclick*="toggleGc"]').textContent = rowData.gc === 'true' ? 'â–²GC' : 'â–¼DC';
                        row.querySelector('input[data-field="distance_from_prev"]').value = rowData.distance_from_prev || '';
                        row.querySelector('input[data-field="distance_from_price"]').value = rowData.distance_from_price || '';
                        row.querySelector('input[data-field="angle"]').value = rowData.angle || '';
                        row.querySelector('input[data-field="thickness"]').value = rowData.thickness || '';
                        row.querySelector('input[data-field="dauten_start_time_str"]').value = rowData.dauten_start_time_str || '';
                        row.querySelector('input[data-field="elapsed_str"]').value = rowData.elapsed_str || '';
                    }
                });

                // èƒŒæ™¯è‰²ã¨è¨ˆç®—ã‚’æ›´æ–°
                document.querySelectorAll('td[data-value]').forEach(cell => {
                    cell.classList.remove('blue-bg', 'red-bg');
                    if (cell.getAttribute('data-value') === 'up' || cell.getAttribute('data-value') === 'true') {
                        cell.classList.add('blue-bg');
                    } else if (cell.getAttribute('data-value') === 'down' || cell.getAttribute('data-value') === 'false') {
                        cell.classList.add('red-bg');
                    }
                });

                document.querySelectorAll('td[onclick*="cycleBos"]').forEach(cell => {
                    updateBosBg(cell);
                });

                document.querySelectorAll('input[data-field]').forEach(input => {
                    if (input.type === 'number') {
                        updateNumericBg(input);
                    } else if (input.getAttribute('data-field').includes('time')) {
                        updateTimeBg(input);
                    }
                });

                updateAllTimeDisplays();
            }
        }

        function setTimeFormat(format) {
            timeFormat = format;
            updateAllTimeDisplays();
        }

        function updateAllTimeDisplays() {
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const tf = row.getAttribute('data-tf');
                
                // è¡Œ:ä¾¡æ ¼ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (tf === 'price') {
                    return;
                }
                
                const dautenInput = row.querySelector('input[data-field="dauten_start_time_str"]');
                const elapsedInput = row.querySelector('input[data-field="elapsed_str"]');
                const diffCell = row.querySelector('.time-diff');
                
                // å…ƒã®æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ç¾åœ¨ã®å€¤ã‚’ä¿å­˜ï¼ˆæ¸¬å®šé–‹å§‹æ—¥æ™‚å½¢å¼ã¨ã—ã¦ï¼‰
                if (!originalTimeData[tf]) {
                    originalTimeData[tf] = {
                        dauten: dautenInput.value,
                        elapsed: elapsedInput.value
                    };
                }
                
                if (timeFormat === 'original') {
                    // ã€Œæ¸¬å®šé–‹å§‹æ—¥æ™‚ã€å½¢å¼ - å…ƒã®å€¤ã‚’è¡¨ç¤ºã€æ™‚é–“å·®ã¯ã€Œï¼ã€
                    dautenInput.value = originalTimeData[tf].dauten || '';
                    elapsedInput.value = originalTimeData[tf].elapsed || '';
                    diffCell.textContent = '-';
                } else {
                    // ä»–ã®å½¢å¼ - çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
                    const dautenTime = parseTime(originalTimeData[tf].dauten);
                    const elapsedTime = parseTime(originalTimeData[tf].elapsed);
                    
                    if (dautenTime) {
                        const now = new Date();
                        const elapsedMs = now - dautenTime;
                        const elapsedMinutes = Math.floor(elapsedMs / 60000);
                        const roundedElapsedMinutes = Math.floor(elapsedMinutes / 5) * 5;
                        dautenInput.value = formatElapsedMinutes(roundedElapsedMinutes, timeFormat);
                    } else {
                        dautenInput.value = originalTimeData[tf].dauten || '';
                    }
                    
                    if (elapsedTime) {
                        const now = new Date();
                        const elapsedMs = now - elapsedTime;
                        const elapsedMinutes = Math.floor(elapsedMs / 60000);
                        const roundedElapsedMinutes = Math.floor(elapsedMinutes / 5) * 5;
                        elapsedInput.value = formatElapsedMinutes(roundedElapsedMinutes, timeFormat);
                    } else {
                        elapsedInput.value = originalTimeData[tf].elapsed || '';
                    }
                    
                    // æ™‚é–“å·®ã®è¨ˆç®—
                    if (dautenTime && elapsedTime) {
                        const dautenCell = row.querySelector('td[data-value]');
                        const gcCell = row.querySelector('td[onclick*="toggleGc"]');
                        const dautenDirection = dautenCell ? dautenCell.getAttribute('data-value') : null;
                        const gcDirection = gcCell ? (gcCell.getAttribute('data-value') === 'true' ? 'up' : 'down') : null;
                        
                        // åŒæ–¹å‘ã‹ãƒã‚§ãƒƒã‚¯
                        if ((dautenDirection === 'up' && gcDirection === 'up') || (dautenDirection === 'down' && gcDirection === 'down')) {
                            const diffMs = Math.abs(elapsedTime - dautenTime);
                            const diffMinutes = Math.floor(diffMs / 60000);
                            const roundedDiffMinutes = Math.floor(diffMinutes / 5) * 5;
                            diffCell.textContent = formatElapsedMinutes(roundedDiffMinutes, timeFormat);
                        } else {
                            diffCell.textContent = '-';
                        }
                    } else {
                        diffCell.textContent = '-';
                    }
                }
                // èƒŒæ™¯è‰²ã‚’æ›´æ–°ã™ã‚‹ãŒã€å…ƒãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã—ãªã„
                const dautenCell = row.querySelector('td[data-value]');
                const gcCell = row.querySelector('td[onclick*="toggleGc"]');
                
                dautenInput.classList.remove('blue-bg', 'red-bg');
                if (dautenCell && dautenCell.getAttribute('data-value') === 'up') {
                    dautenInput.classList.add('blue-bg');
                } else if (dautenCell && dautenCell.getAttribute('data-value') === 'down') {
                    dautenInput.classList.add('red-bg');
                }
                
                elapsedInput.classList.remove('blue-bg', 'red-bg');
                if (gcCell && gcCell.getAttribute('data-value') === 'true') {
                    elapsedInput.classList.add('blue-bg');
                } else if (gcCell && gcCell.getAttribute('data-value') === 'false') {
                    elapsedInput.classList.add('red-bg');
                }
            });
        }

        function formatTime(timeStr, format) {
            if (!timeStr || timeStr === '-') return '-';
            
            try {
                const now = new Date();
                const segments = timeStr.trim().split('/');
                
                if (segments.length < 5) return timeStr;
                
                const year = 2000 + parseInt(segments[0], 10);
                const month = parseInt(segments[1], 10) - 1;
                const day = parseInt(segments[2], 10);
                
                const timePart = segments[3];
                const timeSegments = timePart.split(':');
                
                if (timeSegments.length < 2) return timeStr;
                
                const hour = parseInt(timeSegments[0], 10);
                const minute = parseInt(timeSegments[1], 10);
                
                const startTime = new Date(year, month, day, hour, minute);
                const elapsedMs = now - startTime;
                const elapsedMinutes = Math.floor(elapsedMs / 60000);
                
                const roundedElapsedMinutes = Math.floor(elapsedMinutes / 5) * 5;
                
                return formatElapsedMinutes(roundedElapsedMinutes, format);
            } catch (e) {
                return timeStr;
            }
        }

        function formatElapsedMinutes(minutes, format) {
            if (format === 'm') {
                return minutes + 'm';
            } else if (format === 'hm') {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
            } else if (format === 'dhm') {
                const days = Math.floor(minutes / 1440);
                const remainMins = minutes % 1440;
                const hours = Math.floor(remainMins / 60);
                const mins = remainMins % 60;
                return String(days).padStart(2, '0') + '/' + String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
            }
            return minutes + 'm';
        }

        function toggleDauten(cell) {
            const current = cell.getAttribute('data-value');
            if (current === 'up') {
                cell.textContent = 'â–¼Dow';
                cell.setAttribute('data-value', 'down');
                cell.classList.remove('blue-bg');
                cell.classList.add('red-bg');
            } else {
                cell.textContent = 'â–²Dow';
                cell.setAttribute('data-value', 'up');
                cell.classList.remove('red-bg');
                cell.classList.add('blue-bg');
            }
            updateTimeBg(cell.closest('tr').querySelector('input[data-field="dauten_start_time_str"]'));
            updateTimeBg(cell.closest('tr').querySelector('input[data-field="elapsed_str"]'));
            calculateTimeDiff(cell.closest('tr'));
        }

        function cycleBos(cell) {
            const values = ['-', 'BOS-1', 'BOS-2', 'BOS-3', 'BOS-4', 'BOS-5', 'BOS-6', 'BOS-7', 'BOS-8', 'BOS-9'];
            let current = cell.getAttribute('data-value');
            let index = values.indexOf(current);
            if (index === -1) index = 0;
            index = (index + 1) % values.length;
            cell.textContent = values[index];
            cell.setAttribute('data-value', values[index]);
            updateBosBg(cell);
        }

        function cycleBosReverse(cell) {
            const values = ['-', 'BOS-1', 'BOS-2', 'BOS-3', 'BOS-4', 'BOS-5', 'BOS-6', 'BOS-7', 'BOS-8', 'BOS-9'];
            let current = cell.getAttribute('data-value');
            let index = values.indexOf(current);
            if (index === -1) index = 0;
            index = (index - 1 + values.length) % values.length;
            cell.textContent = values[index];
            cell.setAttribute('data-value', values[index]);
            updateBosBg(cell);
        }

        function updateBosBg(cell) {
            const row = cell.closest('tr');
            const dautenCell = row.querySelector('td[data-value]');
            cell.classList.remove('blue-bg', 'red-bg');
            if (dautenCell) {
                if (dautenCell.getAttribute('data-value') === 'up') {
                    cell.classList.add('blue-bg');
                } else if (dautenCell.getAttribute('data-value') === 'down') {
                    cell.classList.add('red-bg');
                }
            }
        }

        function toggleGc(cell) {
            const current = cell.getAttribute('data-value') === 'true';
            if (current) {
                cell.textContent = 'â–¼DC';
                cell.setAttribute('data-value', 'false');
                cell.classList.remove('blue-bg');
                cell.classList.add('red-bg');
            } else {
                cell.textContent = 'â–²GC';
                cell.setAttribute('data-value', 'true');
                cell.classList.remove('red-bg');
                cell.classList.add('blue-bg');
            }
            updateTimeBg(cell.closest('tr').querySelector('input[data-field="elapsed_str"]'));
            // é›²åšã¿ã®èƒŒæ™¯è‰²ã‚‚æ›´æ–°
            const thicknessInput = cell.closest('tr').querySelector('input[data-field="thickness"]');
            if (thicknessInput) {
                updateNumericBg(thicknessInput);
            }
            calculateTimeDiff(cell.closest('tr'));
        }

        function updateNumericBg(input) {
            const value = parseFloat(input.value);
            const field = input.getAttribute('data-field');
            input.classList.remove('blue-bg', 'red-bg');
            
            // é›²åšã¿(thickness)ã®å ´åˆã¯é›²äº¤å·®(gc)ã®èƒŒæ™¯è‰²ã¨åŒã˜ã«ã™ã‚‹
            if (field === 'thickness') {
                const row = input.closest('tr');
                const gcCell = row.querySelector('td[onclick*="toggleGc"]');
                if (gcCell) {
                    const gcValue = gcCell.getAttribute('data-value');
                    if (gcValue === 'true') {
                        input.classList.add('blue-bg');
                    } else if (gcValue === 'false') {
                        input.classList.add('red-bg');
                    }
                }
            } else {
                // ãã®ä»–ã®æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¾“æ¥é€šã‚Š
                if (value > 0) {
                    input.classList.add('blue-bg');
                } else if (value < 0) {
                    input.classList.add('red-bg');
                }
            }
        }

        function updateTimeBg(input) {
            const row = input.closest('tr');
            const dautenCell = row.querySelector('td[data-value]');
            const gcCell = row.querySelector('td[onclick*="toggleGc"]');
            
            input.classList.remove('blue-bg', 'red-bg');
            if (input.getAttribute('data-field') === 'dauten_start_time_str') {
                if (dautenCell && dautenCell.getAttribute('data-value') === 'up') {
                    input.classList.add('blue-bg');
                } else if (dautenCell && dautenCell.getAttribute('data-value') === 'down') {
                    input.classList.add('red-bg');
                }
            } else if (input.getAttribute('data-field') === 'elapsed_str') {
                if (gcCell && gcCell.getAttribute('data-value') === 'true') {
                    input.classList.add('blue-bg');
                } else if (gcCell && gcCell.getAttribute('data-value') === 'false') {
                    input.classList.add('red-bg');
                }
            }
            // å…ƒã®æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæ¸¬å®šé–‹å§‹æ—¥æ™‚å½¢å¼ã®å ´åˆã®ã¿ï¼‰
            if (timeFormat === 'original') {
                const tf = row.getAttribute('data-tf');
                if (!originalTimeData[tf]) {
                    originalTimeData[tf] = {};
                }
                if (input.getAttribute('data-field') === 'dauten_start_time_str') {
                    originalTimeData[tf].dauten = input.value;
                } else if (input.getAttribute('data-field') === 'elapsed_str') {
                    originalTimeData[tf].elapsed = input.value;
                }
            }
            calculateTimeDiff(row);
        }

        function calculateTimeDiff(row) {
            const dautenTimeInput = row.querySelector('input[data-field="dauten_start_time_str"]');
            const elapsedTimeInput = row.querySelector('input[data-field="elapsed_str"]');
            const diffCell = row.querySelector('.time-diff');
            
            // nullãƒã‚§ãƒƒã‚¯
            if (!dautenTimeInput || !elapsedTimeInput || !diffCell) {
                return;
            }
            
            if (timeFormat === 'original') {
                diffCell.textContent = '-';
                return;
            }
            
            if (!dautenTimeInput.value || !elapsedTimeInput.value) {
                diffCell.textContent = '-';
                return;
            }
            
            try {
                const dautenTime = parseTime(dautenTimeInput.value);
                const elapsedTime = parseTime(elapsedTimeInput.value);
                
                if (dautenTime && elapsedTime) {
                    const dautenCell = row.querySelector('td.editable[onclick*="toggleDauten"]');
                    const gcCell = row.querySelector('td.editable[onclick*="toggleGc"]');
                    const dautenDirection = dautenCell ? dautenCell.getAttribute('data-value') : null;
                    const gcDirection = gcCell ? (gcCell.getAttribute('data-value') === 'true' ? 'up' : 'down') : null;
                    
                    // åŒæ–¹å‘ã‹ãƒã‚§ãƒƒã‚¯
                    if (dautenDirection === 'up' && gcDirection === 'up' || dautenDirection === 'down' && gcDirection === 'down') {
                        const diffMs = Math.abs(elapsedTime - dautenTime);
                        const diffMin = Math.floor(diffMs / 60000);
                        diffCell.textContent = formatElapsedMinutes(diffMin, timeFormat);
                    } else {
                        diffCell.textContent = '-';
                    }
                } else {
                    diffCell.textContent = '-';
                }
            } catch (e) {
                diffCell.textContent = '-';
            }
        }

        function parseTime(timeStr) {
            if (!timeStr || timeStr === '-') return null;
            
            try {
                const segments = timeStr.trim().split('/');
                
                if (segments.length < 4) return null;
                
                const year = 2000 + parseInt(segments[0], 10);
                const month = parseInt(segments[1], 10) - 1;
                const day = parseInt(segments[2], 10);
                
                const timePart = segments[3];
                const timeSegments = timePart.split(':');
                
                if (timeSegments.length < 2) return null;
                
                const hour = parseInt(timeSegments[0], 10);
                const minute = parseInt(timeSegments[1], 10);
                
                return new Date(year, month, day, hour, minute);
            } catch (e) {
                return null;
            }
        }

        function generateJson() {
            const symbol = document.getElementById('symbol').value;
            const price = parseFloat(document.getElementById('price').value);
            const time = Math.floor(Date.now() / 1000) * 1000; // ãƒŸãƒªç§’å˜ä½
            
            const rows = document.querySelectorAll('#dataTable tbody tr');
            const rowDataMap = {};
            
            // å„è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            rows.forEach(row => {
                const tf = row.getAttribute('data-tf');
                if (tf === 'price') return; // ä¾¡æ ¼ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                
                try {
                    const dauten = row.querySelector('td[data-value]').getAttribute('data-value');
                    const bosCount = row.querySelector('td[onclick*="cycleBos"]').getAttribute('data-value');
                    const gc = row.querySelector('td[onclick*="toggleGc"]').getAttribute('data-value') === 'true';
                    
                    const distanceFromPrev = parseFloat(row.querySelector('input[data-field="distance_from_prev"]').value) || 0;
                    const distanceFromPrice = parseFloat(row.querySelector('input[data-field="distance_from_price"]').value) || 0;
                    const angle = parseFloat(row.querySelector('input[data-field="angle"]').value) || 0;
                    const thickness = parseFloat(row.querySelector('input[data-field="thickness"]').value) || 0;
                    
                    const dautenStartTimeStr = row.querySelector('input[data-field="dauten_start_time_str"]').value || '';
                    const elapsedStr = row.querySelector('input[data-field="elapsed_str"]').value || '';
                    
                    rowDataMap[tf] = {
                        dauten: dauten,
                        bos_count: bosCount === '-' ? 0 : parseInt(bosCount.replace('BOS-', '')),
                        gc: gc,
                        distance_from_prev: distanceFromPrev,
                        distance_from_price: distanceFromPrice,
                        angle: angle,
                        thickness: thickness,
                        dauten_start_time_str: dautenStartTimeStr,
                        elapsed_str: elapsedStr
                    };
                } catch (e) {
                    console.error(`Error processing row for ${tf}:`, e);
                }
            });
            
            // ç¾åœ¨ã®è¡¨ã®é †åºã«åŸºã¥ã„ã¦cloud_orderã‚’ç”Ÿæˆ
            const cloudOrder = Array.from(document.querySelectorAll('#dataTable tbody tr')).map(row => row.getAttribute('data-tf'));
            
            // row_orderã‚’å‹•çš„ã«ç”Ÿæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã®ç¾åœ¨ã®é †åºã‹ã‚‰ï¼‰
            const rowOrderFull = cloudOrder;  // 5mç”¨ï¼šå…¨æ™‚é–“è¶³ã®é †åº
            const rowOrder15m = cloudOrder.filter(tf => tf === 'price' || tf === '15m');
            const rowOrder1H = cloudOrder.filter(tf => tf === 'price' || tf === '1H');
            const rowOrder4H = cloudOrder.filter(tf => tf === 'price' || tf === '4H');
            
            // 4ã¤ã®JSONã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            const jsonConfigs = {
                '5m': {
                    label: '5m',
                    tf: '5',
                    bos: rowDataMap['5m'] ? rowDataMap['5m'].bos_count : null,
                    rowOrder: rowOrderFull
                },
                '15m': {
                    label: '15m',
                    tf: '15',
                    bos: rowDataMap['15m'] ? rowDataMap['15m'].bos_count : null,
                    rowOrder: rowOrder15m
                },
                '1H': {
                    label: '1H',
                    tf: '60',
                    bos: rowDataMap['1H'] ? rowDataMap['1H'].bos_count : null,
                    rowOrder: rowOrder1H
                },
                '4H': {
                    label: '4H',
                    tf: '240',
                    bos: rowDataMap['4H'] ? rowDataMap['4H'].bos_count : null,
                    rowOrder: rowOrder4H
                }
            };
            
            // å„ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã®JSONã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            for (const [key, config] of Object.entries(jsonConfigs)) {
                const clouds = [];
                const tfLabel = config.label;
                const tfData = rowDataMap[tfLabel];
                
                if (!tfData) {
                    console.error(`No data found for ${tfLabel}, skipping...`);
                    continue;
                }
                
                // daytrade.bosã®å€¤ã‚’è¨­å®šï¼ˆbos_countã«åŸºã¥ã„ã¦ï¼‰
                let daytradeBos = "-";
                if (config.bos !== null && config.bos !== undefined && config.bos > 0) {
                    daytradeBos = "BOS-" + config.bos;
                }
                
                // Parse dauten_start_time_str to get milliseconds
                let dautenStartTimeMs = time;
                if (tfData.dauten_start_time_str) {
                    const parsedTime = parseTime(tfData.dauten_start_time_str);
                    if (parsedTime) {
                        dautenStartTimeMs = parsedTime.getTime();
                    }
                }
                
                // Parse elapsed_str to get milliseconds for cross_start_time
                let crossStartTimeMs = time;
                if (tfData.elapsed_str) {
                    const parsedTime = parseTime(tfData.elapsed_str);
                    if (parsedTime) {
                        crossStartTimeMs = parsedTime.getTime();
                    }
                }
                
                // Calculate elapsed in seconds from dauten_start_time
                const elapsedSeconds = Math.round((time - dautenStartTimeMs) / 1000);
                
                if (key === '5m') {
                    // 5mç”¨ï¼šã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å«ã‚ã‚‹
                    ['5m', '15m', '1H', '4H'].forEach(tf => {
                        const data = rowDataMap[tf];
                        
                        if (!data) {
                            console.error(`No data for ${tf} in 5m generation, skipping...`);
                            return;
                        }
                        
                        // Parse dauten_start_time_str
                        let dautenMs = time;
                        if (data.dauten_start_time_str) {
                            const parsedTime = parseTime(data.dauten_start_time_str);
                            if (parsedTime) {
                                dautenMs = parsedTime.getTime();
                            }
                        }
                        
                        // Parse elapsed_str
                        let crossMs = time;
                        if (data.elapsed_str) {
                            const parsedTime = parseTime(data.elapsed_str);
                            if (parsedTime) {
                                crossMs = parsedTime.getTime();
                            }
                        }
                        
                        const elapsed = Math.round((time - dautenMs) / 1000);
                        
                        clouds.push({
                            label: tf,
                            tf: tf,
                            gc: data.gc,
                            thickness: data.thickness,
                            angle: data.angle,
                            elapsed: elapsed,
                            cross_start_time: crossMs,
                            elapsed_str: data.elapsed_str,
                            in_cloud: false,
                            star: false,
                            distance_from_price: data.distance_from_price,
                            distance_from_prev: data.distance_from_prev,
                            topPrice: price,
                            bottomPrice: price,
                            dauten: data.dauten,
                            bos_count: data.bos_count,
                            dauten_start_time: dautenMs,
                            dauten_start_time_str: data.dauten_start_time_str
                        });
                    });
                } else {
                    // 15mã€1Hã€4Hç”¨ï¼šå¯¾å¿œã™ã‚‹ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã¿
                    clouds.push({
                        label: tfLabel,
                        tf: tfLabel,
                        gc: tfData.gc,
                        topPrice: price,
                        bottomPrice: price,
                        dauten: tfData.dauten,
                        bos_count: tfData.bos_count,
                        dauten_start_time: dautenStartTimeMs,
                        dauten_start_time_str: tfData.dauten_start_time_str
                    });
                }
                
                const jsonData = {
                    symbol: symbol,
                    tf: config.tf,
                    time: time,
                    state: {"flag": "", "word": ""},
                    daytrade: {"status": "active", "bos": daytradeBos, "time": "25/11/12/14:30"},
                    swing: {"status": "inactive", "bos": 0, "time": ""},
                    row_order: config.rowOrder,
                    cloud_order: key === '5m' ? cloudOrder : [tfLabel],
                    clouds: clouds,
                    meta: {},
                    price: price
                };
                
                // ç”Ÿæˆã—ãŸJSONã‚’ä¿å­˜
                window[`jsonData_${key}`] = jsonData;
                
                // JSONOutputæ¬„ã«è¡¨ç¤º
                const outputId = `jsonOutput${key}`;
                document.getElementById(outputId).textContent = JSON.stringify(jsonData, null, 2);
            }
            
            // æœ€åˆã®ã‚¿ãƒ–ï¼ˆ5mï¼‰ã‚’è¡¨ç¤º
            switchJsonView('5m');
        }
        
        function switchJsonView(tf) {
            console.log('switchJsonView called with:', tf);
            // ã™ã¹ã¦ã®JSONå‡ºåŠ›æ¬„ã‚’éè¡¨ç¤º
            document.getElementById('jsonOutput5m').style.display = 'none';
            document.getElementById('jsonOutput15m').style.display = 'none';
            document.getElementById('jsonOutput1H').style.display = 'none';
            document.getElementById('jsonOutput4H').style.display = 'none';
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            const outputId = `jsonOutput${tf}`;
            console.log('showing output:', outputId);
            document.getElementById(outputId).style.display = 'block';
        }
        
        async function sendSingleJson(tf) {
            console.log('sendSingleJson called with:', tf);
            
            // JSONãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const jsonDataKey = `jsonData_${tf}`;
            if (!window[jsonDataKey]) {
                console.warn(`${tf} JSON data not found`);
                alert(`${tf}ã®JSONãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšJSONç”Ÿæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            const target = document.querySelector('input[name="target"]:checked').value;
            console.log('target:', target);
            
            let url;
            if (target === 'test') {
                url = 'http://localhost:5000/webhook';
            } else {
                url = 'https://tradingview-webhook-s5x1.onrender.com/webhook';
            }
            
            console.log('sending to URL:', url);
            
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `${tf}é€ä¿¡ä¸­...`;
            statusDiv.className = 'status';
            statusDiv.style.display = 'block';
            
            try {
                console.log(`sending ${tf}...`);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(window[jsonDataKey])
                });
                
                console.log(`${tf} response status:`, response.status);
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    result = { error: 'Could not parse response', status: response.status };
                }
                
                const success = response.ok;
                const message = success ? 'æˆåŠŸ' : 'å¤±æ•—';
                
                statusDiv.className = 'status ' + (success ? 'success' : 'error');
                statusDiv.textContent = `${tf}é€ä¿¡çµæœ: ${message}\nè©³ç´°: ${JSON.stringify(result)}`;
                statusDiv.style.display = 'block';
                
                console.log(`${tf} send complete. success:`, success);
            } catch (error) {
                console.error(`Error sending ${tf}:`, error);
                statusDiv.className = 'status error';
                statusDiv.textContent = `${tf}é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusDiv.style.display = 'block';
            }
        }
        
        async function sendJson() {
            console.log('sendJson() called');
            
            // JSONãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (!window.jsonData_5m || !window.jsonData_15m || !window.jsonData_1H || !window.jsonData_4H) {
                console.warn('JSON data not found');
                alert('ã¾ãšJSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            const selectedTf = document.querySelector('input[name="selected_tf"]:checked').value;
            const target = document.querySelector('input[name="target"]:checked').value;
            console.log('selected tf:', selectedTf, 'target:', target);
            
            // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã¾ã§ã®JSONã‚’é€ä¿¡
            const tfHierarchy = {
                '5m': ['5m'],
                '15m': ['5m', '15m'],
                '1H': ['5m', '15m', '1H'],
                '4H': ['5m', '15m', '1H', '4H']
            };
            
            const tfsToSend = tfHierarchy[selectedTf];
            console.log('tfs to send:', tfsToSend);
            
            let url;
            if (target === 'test') {
                url = 'http://localhost:5000/webhook';
            } else {
                url = 'https://tradingview-webhook-s5x1.onrender.com/webhook';
            }
            
            console.log('sending to URL:', url);
            
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `${selectedTf}é€ä¿¡ä¸­...`;
            statusDiv.className = 'status';
            statusDiv.style.display = 'block';
            
            const results = [];
            
            for (const tf of tfsToSend) {
                try {
                    console.log(`sending ${tf}...`);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(window[`jsonData_${tf}`])
                    });
                    
                    console.log(`${tf} response status:`, response.status);
                    
                    let result;
                    try {
                        result = await response.json();
                    } catch (e) {
                        result = { error: 'Could not parse response', status: response.status };
                    }
                    
                    results.push({
                        tf: tf,
                        success: response.ok,
                        message: response.ok ? 'æˆåŠŸ' : 'å¤±æ•—',
                        details: result
                    });
                    
                    console.log(`${tf} result:`, results[results.length - 1]);
                } catch (error) {
                    console.error(`Error sending ${tf}:`, error);
                    results.push({
                        tf: tf,
                        success: false,
                        message: 'ã‚¨ãƒ©ãƒ¼',
                        details: error.message
                    });
                }
                
                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã«500ms ã®é…å»¶ã‚’å…¥ã‚Œã‚‹ï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ï¼‰
                if (tfsToSend.indexOf(tf) < tfsToSend.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // çµæœã‚’è¡¨ç¤º
            let resultText = `${selectedTf}é€ä¿¡çµæœ:\n\n`;
            let allSuccess = true;
            results.forEach(r => {
                resultText += `ã€${r.tf}ã€‘\n`;
                resultText += `  çŠ¶æ…‹: ${r.message}\n`;
                resultText += `  è©³ç´°: ${JSON.stringify(r.details)}\n\n`;
                if (!r.success) allSuccess = false;
            });
            
            statusDiv.className = 'status ' + (allSuccess ? 'success' : 'error');
            statusDiv.textContent = resultText;
            statusDiv.style.display = 'block';
            
            console.log('send complete. all success:', allSuccess);
        }
        
        // ===== ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆæ–°è¦è¿½åŠ ï¼‰ =====
        
        let currentPasteTab = '5m'; // ç¾åœ¨é¸æŠä¸­ã®ãƒšãƒ¼ã‚¹ãƒˆã‚¿ãƒ–
        
        // ãƒšãƒ¼ã‚¹ãƒˆç”¨ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchPasteJsonView(tf) {
            // ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('indicatorJsonPaste5m').style.display = 'none';
            document.getElementById('indicatorJsonPaste15m').style.display = 'none';
            document.getElementById('indicatorJsonPaste1H').style.display = 'none';
            document.getElementById('indicatorJsonPaste4H').style.display = 'none';
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
            document.getElementById(`indicatorJsonPaste${tf}`).style.display = 'block';
            currentPasteTab = tf;
        }
        
        // å˜ä¸€JSONã‚’è¡¨ã«åæ˜ ã™ã‚‹å†…éƒ¨é–¢æ•°
        // targetTf: æŒ‡å®šã•ã‚ŒãŸTFã®cloudã®ã¿ã‚’å‡¦ç†ã™ã‚‹ï¼ˆnullã®å ´åˆã¯å…¨ã¦ã®cloudã‚’å‡¦ç†ï¼‰
        function applySingleJsonToTable(jsonText, applyOrder = false, targetTf = null) {
            const data = JSON.parse(jsonText);
            
            // Symbol ã¨ Price ã‚’è¨­å®š
            if (data.symbol) {
                document.getElementById('symbol').value = data.symbol;
            }
            if (data.price) {
                document.getElementById('price').value = data.price;
            }
            
            // cloud_order ã¾ãŸã¯ row_order ã‹ã‚‰é›²æ•´åˆ—ã®é †åºã‚’åæ˜ ï¼ˆapplyOrder=trueã®å ´åˆã®ã¿ï¼‰
            if (applyOrder) {
                // row_order ã‚’å„ªå…ˆï¼ˆå®Ÿéš›ã®è¡¨ç¤ºé †åºï¼‰ã€ãªã‘ã‚Œã° cloud_order ã‚’ä½¿ç”¨
                let orderSource = null;
                if (data.row_order && data.row_order.length > 0) {
                    orderSource = data.row_order;
                    console.log('[ORDER] Using row_order:', orderSource);
                } else if (data.cloud_order && data.cloud_order.length > 0) {
                    orderSource = data.cloud_order;
                    console.log('[ORDER] Using cloud_order:', orderSource);
                }
                
                if (orderSource && orderSource.length > 0) {
                    const tbody = document.querySelector('#dataTable tbody');
                    
                    // å…¨TFã®ãƒªã‚¹ãƒˆ
                    const allTfs = ['5m', '15m', '1H', '4H', 'price'];
                    const orderedTfs = [];
                    
                    // orderSource ã®é †åºã§è¿½åŠ 
                    orderSource.forEach(tf => {
                        if (allTfs.includes(tf) && !orderedTfs.includes(tf)) {
                            orderedTfs.push(tf);
                        }
                    });
                    
                    // orderSourceã«å«ã¾ã‚Œã¦ã„ãªã„TFã‚’è¿½åŠ 
                    allTfs.forEach(tf => {
                        if (!orderedTfs.includes(tf)) {
                            // price ã¯æœ€å¾Œã«è¿½åŠ 
                            if (tf === 'price') {
                                orderedTfs.push(tf);
                            } else {
                                // ä»–ã®TFã¯priceã®å‰ã«è¿½åŠ 
                                const priceIndex = orderedTfs.indexOf('price');
                                if (priceIndex >= 0) {
                                    orderedTfs.splice(priceIndex, 0, tf);
                                } else {
                                    orderedTfs.push(tf);
                                }
                            }
                        }
                    });
                    
                    console.log('[ORDER] Final order:', orderedTfs);
                    
                    // è¡Œã‚’ä¸¦ã¹æ›¿ãˆ
                    orderedTfs.forEach(tf => {
                        const row = tbody.querySelector(`tr[data-tf="${tf}"]`);
                        if (row) {
                            tbody.appendChild(row);
                        }
                    });
                }
            }
            
            // daytrade ã‹ã‚‰çªç ´æ•°(bos)ã¨ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—
            let daytradeBos = null;
            let daytradeTf = null;
            if (data.daytrade && data.daytrade.bos) {
                daytradeBos = data.daytrade.bos;
                // daytrade.tf ãŒã‚ã‚Œã°ãã®TFã«ã®ã¿é©ç”¨ã€ãªã‘ã‚Œã°clouds[0]ã®TFã‚’ä½¿ç”¨
                if (data.daytrade.tf) {
                    daytradeTf = data.daytrade.tf;
                } else if (data.clouds && data.clouds.length > 0) {
                    daytradeTf = data.clouds[0].label || data.clouds[0].tf;
                }
            }
            
            // clouds é…åˆ—ã‹ã‚‰è¡¨ã«åæ˜ 
            let clouds = data.clouds || [];
            
            // targetTfãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®TFã®cloudã®ã¿ã‚’å‡¦ç†
            if (targetTf) {
                clouds = clouds.filter(cloud => {
                    const tfLabel = cloud.label || cloud.tf;
                    return tfLabel === targetTf;
                });
            }
            
            clouds.forEach(cloud => {
                const tfLabel = cloud.label || cloud.tf;
                const row = document.querySelector(`#dataTable tbody tr[data-tf="${tfLabel}"]`);
                if (!row) return;
                
                // ãƒ€ã‚¦è»¢
                const dautenCell = row.querySelector('td[onclick*="toggleDauten"]');
                if (dautenCell && cloud.dauten !== undefined) {
                    const isUp = cloud.dauten === 'up';
                    dautenCell.setAttribute('data-value', isUp ? 'up' : 'down');
                    dautenCell.textContent = isUp ? 'â–²Dow' : 'â–¼Dow';
                    dautenCell.classList.remove('blue-bg', 'red-bg');
                    dautenCell.classList.add(isUp ? 'blue-bg' : 'red-bg');
                }
                
                // çªç ´æ•° - daytrade.bos ã¯è©²å½“TFã«ã®ã¿é©ç”¨ã€ãã‚Œä»¥å¤–ã¯ cloud.bos_count ã‚’ä½¿ç”¨
                const bosCell = row.querySelector('td[onclick*="cycleBos"]');
                if (bosCell) {
                    let bosValue = '-';
                    // daytrade.bos ã¯ daytradeTf ã¨ä¸€è‡´ã™ã‚‹TFã«ã®ã¿é©ç”¨
                    if (daytradeBos && daytradeBos !== '-' && tfLabel === daytradeTf) {
                        // daytrade.bos ã‚’ä½¿ç”¨ï¼ˆä¾‹: "BOS-1" â†’ ãã®ã¾ã¾ä½¿ç”¨ï¼‰
                        bosValue = daytradeBos;
                    } else if (cloud.bos_count !== undefined && cloud.bos_count !== null && cloud.bos_count !== 0) {
                        bosValue = `BOS-${cloud.bos_count}`;
                    }
                    bosCell.setAttribute('data-value', bosValue);
                    bosCell.textContent = bosValue;
                    updateBosBg(bosCell);
                }
                
                // é›²äº¤å·® (gc)
                const gcCell = row.querySelector('td[onclick*="toggleGc"]');
                if (gcCell && cloud.gc !== undefined) {
                    const isGc = cloud.gc === true;
                    gcCell.setAttribute('data-value', isGc ? 'true' : 'false');
                    gcCell.textContent = isGc ? 'â–²GC' : 'â–¼DC';
                    gcCell.classList.remove('blue-bg', 'red-bg');
                    gcCell.classList.add(isGc ? 'blue-bg' : 'red-bg');
                }
                
                // å„é›²é–“ (distance_from_prev) - å°æ•°ç‚¹1æ¡ã«å››æ¨äº”å…¥
                const distPrevInput = row.querySelector('input[data-field="distance_from_prev"]');
                if (distPrevInput && cloud.distance_from_prev !== undefined) {
                    distPrevInput.value = Math.round(cloud.distance_from_prev * 10) / 10;
                    updateNumericBg(distPrevInput);
                }
                
                // ä¾¡æ ¼é–“ (distance_from_price) - å°æ•°ç‚¹1æ¡ã«å››æ¨äº”å…¥
                const distPriceInput = row.querySelector('input[data-field="distance_from_price"]');
                if (distPriceInput && cloud.distance_from_price !== undefined) {
                    distPriceInput.value = Math.round(cloud.distance_from_price * 10) / 10;
                    updateNumericBg(distPriceInput);
                }
                
                // é›²è§’åº¦ (angle) - å°æ•°ç‚¹1æ¡ã«å››æ¨äº”å…¥
                const angleInput = row.querySelector('input[data-field="angle"]');
                if (angleInput && cloud.angle !== undefined) {
                    angleInput.value = Math.round(cloud.angle * 10) / 10;
                    updateNumericBg(angleInput);
                }
                
                // é›²åšã¿ (thickness) - å°æ•°ç‚¹1æ¡ã«å››æ¨äº”å…¥
                const thicknessInput = row.querySelector('input[data-field="thickness"]');
                if (thicknessInput && cloud.thickness !== undefined) {
                    thicknessInput.value = Math.round(cloud.thickness * 10) / 10;
                    updateNumericBg(thicknessInput);
                }
                
                // ãƒ€ã‚¦æ™‚é–“ (dauten_start_time_str)
                const dautenTimeInput = row.querySelector('input[data-field="dauten_start_time_str"]');
                if (dautenTimeInput && cloud.dauten_start_time_str) {
                    dautenTimeInput.value = cloud.dauten_start_time_str;
                    if (!originalTimeData[tfLabel]) {
                        originalTimeData[tfLabel] = {};
                    }
                    originalTimeData[tfLabel].dauten = cloud.dauten_start_time_str;
                    updateTimeBg(dautenTimeInput);
                }
                
                // äº¤å·®æ™‚é–“ (elapsed_str)
                const elapsedInput = row.querySelector('input[data-field="elapsed_str"]');
                if (elapsedInput && cloud.elapsed_str) {
                    elapsedInput.value = cloud.elapsed_str;
                    if (!originalTimeData[tfLabel]) {
                        originalTimeData[tfLabel] = {};
                    }
                    originalTimeData[tfLabel].elapsed = cloud.elapsed_str;
                    updateTimeBg(elapsedInput);
                }
                
                // æ™‚é–“å·®ã‚’å†è¨ˆç®—
                calculateTimeDiff(row);
            });
            
            return clouds.length;
        }
        
        // ãƒšãƒ¼ã‚¹ãƒˆã—ãŸJSONã‚’è¡¨ã«åæ˜ ï¼ˆè¤‡æ•°ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ å¯¾å¿œï¼‰
        function applyPastedJsonToTable() {
            const statusDiv = document.getElementById('jsonPasteStatus');
            const selectedTf = document.querySelector('input[name="paste_tf"]:checked').value;
            
            // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã¾ã§ã®JSONã‚’åæ˜ 
            const tfHierarchy = {
                '5m': ['5m'],
                '15m': ['5m', '15m'],
                '1H': ['5m', '15m', '1H'],
                '4H': ['5m', '15m', '1H', '4H']
            };
            
            const tfsToApply = tfHierarchy[selectedTf];
            let totalClouds = 0;
            let errors = [];
            
            for (const tf of tfsToApply) {
                const textarea = document.getElementById(`indicatorJsonPaste${tf}`);
                const jsonText = textarea.value.trim();
                
                if (!jsonText) {
                    continue; // ç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }
                
                try {
                    // 5m JSONã®ã¿é›²æ•´åˆ—é †åºã‚’é©ç”¨ï¼ˆå…¨TFã®cloud_orderã‚’å«ã‚€ãŸã‚ï¼‰
                    const applyOrder = (tf === '5m');
                    // å„TFã®JSONã¯ãã®TFã®cloudã®ã¿ã‚’å‡¦ç†ã™ã‚‹
                    const count = applySingleJsonToTable(jsonText, applyOrder, tf);
                    totalClouds += count;
                } catch (e) {
                    errors.push(`${tf}: ${e.message}`);
                }
            }
            
            if (errors.length > 0) {
                statusDiv.textContent = `âœ— ã‚¨ãƒ©ãƒ¼: ${errors.join(', ')}`;
                statusDiv.className = 'json-paste-status error';
            } else if (totalClouds === 0) {
                statusDiv.textContent = 'JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                statusDiv.className = 'json-paste-status error';
            } else {
                statusDiv.textContent = `âœ“ è¡¨ã«åæ˜ ã—ã¾ã—ãŸï¼ˆ${selectedTf}ã¾ã§ã€${totalClouds}ä»¶ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼‰`;
                statusDiv.className = 'json-paste-status success';
            }
            statusDiv.style.display = 'block';
        }
        
        // ãƒšãƒ¼ã‚¹ãƒˆã—ãŸJSONã‚’ç›´æ¥é€ä¿¡ï¼ˆè¤‡æ•°ã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ å¯¾å¿œï¼‰
        async function directSendPastedJson() {
            const statusDiv = document.getElementById('jsonPasteStatus');
            const selectedTf = document.querySelector('input[name="paste_tf"]:checked').value;
            
            // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã¾ã§ã®JSONã‚’é€ä¿¡
            const tfHierarchy = {
                '5m': ['5m'],
                '15m': ['5m', '15m'],
                '1H': ['5m', '15m', '1H'],
                '4H': ['5m', '15m', '1H', '4H']
            };
            
            const tfsToSend = tfHierarchy[selectedTf];
            
            const target = document.querySelector('input[name="target"]:checked').value;
            let url;
            if (target === 'test') {
                url = 'http://localhost:5000/webhook';
            } else {
                url = 'https://tradingview-webhook-s5x1.onrender.com/webhook';
            }
            
            statusDiv.textContent = `${selectedTf}é€ä¿¡ä¸­...`;
            statusDiv.className = 'json-paste-status';
            statusDiv.style.display = 'block';
            
            const results = [];
            let hasData = false;
            
            for (const tf of tfsToSend) {
                const textarea = document.getElementById(`indicatorJsonPaste${tf}`);
                const jsonText = textarea.value.trim();
                
                if (!jsonText) {
                    continue; // ç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }
                
                hasData = true;
                
                try {
                    const data = JSON.parse(jsonText);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    let result;
                    try {
                        result = await response.json();
                    } catch (e) {
                        result = { status: response.status };
                    }
                    
                    results.push({
                        tf: tf,
                        success: response.ok,
                        message: response.ok ? 'æˆåŠŸ' : 'å¤±æ•—',
                        details: result
                    });
                    
                } catch (e) {
                    results.push({
                        tf: tf,
                        success: false,
                        message: 'å¤±æ•—',
                        details: e.message
                    });
                }
                
                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã«500ms ã®é…å»¶ã‚’å…¥ã‚Œã‚‹
                if (tfsToSend.indexOf(tf) < tfsToSend.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            if (!hasData) {
                statusDiv.textContent = 'JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                statusDiv.className = 'json-paste-status error';
                return;
            }
            
            // çµæœã‚’è¡¨ç¤º
            let allSuccess = results.every(r => r.success);
            let resultText = results.map(r => `${r.tf}: ${r.message}`).join(', ');
            
            if (allSuccess) {
                statusDiv.textContent = `âœ“ ç›´æ¥é€ä¿¡æˆåŠŸï¼ˆ${selectedTf}ã¾ã§ï¼‰: ${resultText}`;
                statusDiv.className = 'json-paste-status success';
            } else {
                statusDiv.textContent = `âœ— ä¸€éƒ¨å¤±æ•—: ${resultText}`;
                statusDiv.className = 'json-paste-status error';
            }
        }
        
        // ãƒšãƒ¼ã‚¹ãƒˆé ˜åŸŸã‚’ã‚¯ãƒªã‚¢
        function clearPastedJson() {
            document.getElementById('indicatorJsonPaste5m').value = '';
            document.getElementById('indicatorJsonPaste15m').value = '';
            document.getElementById('indicatorJsonPaste1H').value = '';
            document.getElementById('indicatorJsonPaste4H').value = '';
            const statusDiv = document.getElementById('jsonPasteStatus');
            statusDiv.textContent = '';
            statusDiv.className = 'json-paste-status';
            statusDiv.style.display = 'none';
        }
        
        // ===== ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼JSONãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ã“ã“ã¾ã§ =====
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’è¨­å®š
            changeFontSize(14);
            document.getElementById('fontSize').value = '14';
            
            // ãƒ­ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
            updateLoadSelect();
            
            // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã‚’è¨­å®š
            window.addEventListener('beforeunload', autoSave);
            
            // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadAutoSave();
            
            // Initialize background colors
            document.querySelectorAll('td[data-value]').forEach(cell => {
                if (cell.getAttribute('data-value') === 'up' || cell.getAttribute('data-value') === 'true') {
                    cell.classList.add('blue-bg');
                } else if (cell.getAttribute('data-value') === 'down' || cell.getAttribute('data-value') === 'false') {
                    cell.classList.add('red-bg');
                }
            });
            
            document.querySelectorAll('td[onclick*="cycleBos"]').forEach(cell => {
                updateBosBg(cell);
            });
            
            document.querySelectorAll('input[data-field]').forEach(input => {
                if (input.type === 'number') {
                    updateNumericBg(input);
                } else if (input.getAttribute('data-field').includes('time')) {
                    updateTimeBg(input);
                }
            });
            
            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                calculateTimeDiff(row);
            });
        });
    </script>
</body>
</html>