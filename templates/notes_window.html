<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ¼ãƒˆ - TradingView Webhook</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* ===== ãƒ†ãƒ¼ãƒå®šç¾© ===== */
    /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒï¼ˆå›ºå®šï¼‰ */
    body {
      background: #2a2a35;
      color: #f5f7ff;
    }
    .header {
      background: #2a2a35;
      border-bottom-color: rgba(255,255,255,0.1);
    }
    .header h2 { color: #f5f7ff; }
    .note-section {
      background: #666673 !important;
      border-color: rgba(255,255,255,0.1);
    }
    .note-section:hover { background: #a8a8a9; }
    .note-section-header {
      background: #2a2a35;
    }
    .note-content textarea, .note-content {
      background: #2a2a35;
      color: #f5f7ff;
    }
    .note-images {
      background: #2a2a35;
    }
    .btn-primary, .btn-success, .btn-purple, .btn-add {
      background: rgba(0, 0, 0, 0.6); color: #ffffff; border-color: #ffffff;
    }
    .font-size-select { background: rgba(0,0,0,0.2); color: #ffffff; border-color: rgba(255,255,255,0.3); }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
      min-height: 100vh;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .header h2 {
      margin: 0;
      font-size: 1.4em;
      color: #f5f7ff;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .btn-primary, .btn-success, .btn-purple, .btn-add {
      background: rgba(0, 0, 0, 0.6);
      color: #ffffff;
      border: 1px solid #ffffff;
    }
    .btn-primary:hover, .btn-success:hover, .btn-purple:hover, .btn-add:hover {
      background: rgba(0, 0, 0, 0.8);
    }
    
    .font-size-select {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.2);
      color: #ffffff;
      font-size: 13px;
      width: 70px;
    }
    
    #noteSectionsContainer {
      flex: 1;
      overflow-y: auto;
      min-height: 200px;
      padding: 4px;
    }
    
    .note-section {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
    }
    .note-section:hover {
      background: rgba(255,255,255,0.08);
    }
    .note-section.dragging {
      opacity: 0.5;
    }
    
    .note-section-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      background: transparent;
    }
    
    .note-section-title-wrapper {
      flex: 1;
      background: #2a2a35;
      border-radius: 4px;
      padding: 2px;
    }
    
    .note-section-title {
      width: 100%;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #2a2a35 !important;
      color: #f5f7ff;
      font-size: 14px;
      font-weight: 500;
    }
    .note-section-title:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .note-section-content {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #2a2a35 !important;
      color: #f5f7ff;
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
    }
    .note-section-content:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .note-section-delete {
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #ffffff;
      border: 1px solid #ffffff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .note-section-delete:hover { background: rgba(0, 0, 0, 0.8); }
    
    .note-section-images {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      padding: 10px;
      background: #2a2a35 !important;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.1);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .note-image-thumb {
      width: 60px;
      height: 60px;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
    }
    .note-image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .drop-zone {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 4px;
      padding: 16px;
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .drop-zone.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .page-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: auto;
    }
    
    .page-nav-left {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .page-nav-btn {
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #ffffff;
      border: 1px solid #ffffff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .page-nav-btn:hover { background: rgba(0, 0, 0, 0.8); }
    .page-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #pageIndicator {
      font-size: 0.9em;
      color: rgba(255,255,255,0.8);
    }
    
    #pageTitleInput {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #ffffff;
      background: rgba(0, 0, 0, 0.6);
      color: #ffffff;
      text-align: center;
      margin-left: 8px;
    }
    
    .btn-page-add, .btn-page-delete {
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.6);
      color: #ffffff;
      border: 1px solid #ffffff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-page-add:hover, .btn-page-delete:hover {
      background: rgba(0, 0, 0, 0.8);
    }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
    .status-bar {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      text-align: right;
      padding-top: 4px;
    }
    
    /* ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« */
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      cursor: pointer;
    }
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ãƒãƒ¼ãƒˆ</h2>
    <div class="header-buttons">
      <select id="noteFontSizeSelect" class="font-size-select">
        <option value="11">11px</option>
        <option value="12">12px</option>
        <option value="13">13px</option>
        <option value="14">14px</option>
        <option value="15" selected>15px</option>
        <option value="16">16px</option>
        <option value="17">17px</option>
        <option value="18">18px</option>
      </select>
      <button id="addNoteSection" class="btn btn-add">é …ç›®è¿½åŠ </button>
      <button id="saveNote" class="btn btn-primary">ä¿å­˜</button>
      <button id="exportNote" class="btn btn-success">å‡ºåŠ›</button>
      <button id="importNote" class="btn btn-purple">èª­è¾¼</button>
    </div>
  </div>
  
  <div id="noteSectionsContainer">
    <!-- ãƒãƒ¼ãƒˆé …ç›®ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
  </div>
  
  <div class="page-navigation">
    <div class="page-nav-left">
      <button id="prevPage" class="page-nav-btn">â—€</button>
      <span id="pageIndicator">1/1</span>
      <button id="nextPage" class="page-nav-btn">â–¶</button>
      <input type="text" id="pageTitleInput" placeholder="ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«">
    </div>
    <div style="display:flex;gap:6px;">
      <button id="addPage" class="btn-page-add">+ãƒšãƒ¼ã‚¸</button>
      <button id="deletePage" class="btn-page-delete">å‰Šé™¤</button>
    </div>
  </div>
  
  <div class="status-bar">
    <span id="saveStatus">èª­ã¿è¾¼ã¿ä¸­...</span>
  </div>
  
  <script>
// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
let notePages = [];
let currentNotePage = 0;
let db = null; // IndexedDB
let autoSaveTimer = null;
let socket = null;

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', async () => {
  console.log('[NOTE WINDOW] Initializing...');
  
  // IndexedDB åˆæœŸåŒ–
  await initIndexedDB();
  
  // SocketIO æ¥ç¶š
  initSocketIO();
  
  // ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  await loadNotePages();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
  setupEventHandlers();
  
  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¾©å…ƒ
  restoreFontSize();
  
  console.log('[NOTE WINDOW] Initialization complete');
});

// ===== SocketIO =====
function initSocketIO() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const socketUrl = `${window.location.protocol}//${window.location.host}`;
  
  socket = io(socketUrl, {
    transports: ['websocket', 'polling'],
    reconnection: true,
    reconnectionAttempts: 10,
    reconnectionDelay: 1000
  });
  
  socket.on('connect', () => {
    console.log('[NOTE WINDOW] SocketIO connected');
    updateStatus('æ¥ç¶šæ¸ˆã¿');
  });
  
  socket.on('disconnect', () => {
    console.log('[NOTE WINDOW] SocketIO disconnected');
    updateStatus('åˆ‡æ–­');
  });
  
  // ä»–ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã®ãƒãƒ¼ãƒˆæ›´æ–°ã‚’å—ä¿¡
  socket.on('note_updated', async (data) => {
    console.log('[NOTE WINDOW] Received note_updated event');
    // è‡ªåˆ†è‡ªèº«ã®æ›´æ–°ã§ãªã‘ã‚Œã°ãƒªãƒ­ãƒ¼ãƒ‰
    if (data.source !== 'notes_window') {
      await loadNotePages();
    }
  });
}

// ===== IndexedDB =====
async function initIndexedDB() {
  return new Promise((resolve) => {
    if (!window.indexedDB) {
      console.warn('[INDEXEDDB] Not supported');
      resolve(false);
      return;
    }
    
    try {
      const request = indexedDB.open('TradingViewNotes', 2);
      
      request.onerror = (e) => {
        console.error('[INDEXEDDB] Open error:', e);
        resolve(false);
      };
      
      request.onsuccess = (e) => {
        db = e.target.result;
        console.log('[INDEXEDDB] Opened successfully');
        resolve(true);
      };
      
      request.onupgradeneeded = (e) => {
        const database = e.target.result;
        if (!database.objectStoreNames.contains('noteImages')) {
          database.createObjectStore('noteImages', { keyPath: 'hash' });
        }
        if (!database.objectStoreNames.contains('noteMetadata')) {
          database.createObjectStore('noteMetadata', { keyPath: 'id' });
        }
      };
    } catch (e) {
      console.error('[INDEXEDDB] Error:', e);
      resolve(false);
    }
  });
}

// IndexedDB ã«ç”»åƒä¿å­˜
async function saveImageToIndexedDB(imageHash, base64Data) {
  return new Promise((resolve) => {
    if (!db) { resolve(false); return; }
    try {
      const transaction = db.transaction(['noteImages'], 'readwrite');
      const store = transaction.objectStore('noteImages');
      store.put({ hash: imageHash, data: base64Data, savedAt: new Date().toISOString() });
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => resolve(false);
    } catch (e) { resolve(false); }
  });
}

// IndexedDB ã‹ã‚‰ç”»åƒå–å¾—
async function getImageFromIndexedDB(imageHash) {
  return new Promise((resolve) => {
    if (!db) { resolve(null); return; }
    try {
      const transaction = db.transaction(['noteImages'], 'readonly');
      const store = transaction.objectStore('noteImages');
      const request = store.get(imageHash);
      request.onsuccess = () => resolve(request.result?.data || null);
      request.onerror = () => resolve(null);
    } catch (e) { resolve(null); }
  });
}

// IndexedDB ã‹ã‚‰ç”»åƒå‰Šé™¤
async function deleteImageFromIndexedDB(imageHash) {
  return new Promise((resolve) => {
    if (!db) { resolve(false); return; }
    try {
      const transaction = db.transaction(['noteImages'], 'readwrite');
      const store = transaction.objectStore('noteImages');
      store.delete(imageHash);
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => resolve(false);
    } catch (e) { resolve(false); }
  });
}

// ===== ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿ãƒ»ä¿å­˜ =====
async function loadNotePages() {
  try {
    updateStatus('èª­ã¿è¾¼ã¿ä¸­...');
    
    const response = await fetch('/api/load_notes');
    if (!response.ok) throw new Error('Failed to load notes');
    
    const data = await response.json();
    
    if (data.notes && Array.isArray(data.notes) && data.notes.length > 0) {
      notePages = data.notes;
      currentNotePage = Math.min(
        parseInt(localStorage.getItem('tv_note_current_page')) || 0,
        notePages.length - 1
      );
      console.log('[NOTE WINDOW] Loaded', notePages.length, 'pages');
    } else {
      createDefaultPages();
    }
    
    updatePageNavigation();
    loadCurrentPage();
    updateStatus('èª­ã¿è¾¼ã¿å®Œäº†');
    
  } catch (error) {
    console.error('[NOTE WINDOW] Load error:', error);
    createDefaultPages();
    updatePageNavigation();
    loadCurrentPage();
    updateStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
  }
}

async function saveNotePages() {
  if (notePages.length === 0) return;
  
  // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
  if (currentNotePage < notePages.length) {
    notePages[currentNotePage].sections = getCurrentPageSections();
    notePages[currentNotePage].lastModified = new Date().toISOString();
  }
  
  try {
    updateStatus('ä¿å­˜ä¸­...');
    
    const response = await fetch('/api/save_notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(notePages)
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      updateStatus('ä¿å­˜å®Œäº†');
      console.log('[NOTE WINDOW] Saved successfully');
      
      // ä»–ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€šçŸ¥
      if (socket && socket.connected) {
        socket.emit('note_updated', { source: 'notes_window' });
      }
    } else {
      updateStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
    }
  } catch (error) {
    console.error('[NOTE WINDOW] Save error:', error);
    updateStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
  }
}

function createDefaultPages() {
  notePages = [{
    id: 1,
    title: 'ãƒãƒ¼ãƒˆ',
    sections: [],
    lastModified: new Date().toISOString()
  }];
  currentNotePage = 0;
}

// ===== UI æ›´æ–° =====
function loadCurrentPage() {
  if (notePages.length === 0) return;
  
  const page = notePages[currentNotePage];
  const container = document.getElementById('noteSectionsContainer');
  container.innerHTML = '';
  
  if (!page.sections || page.sections.length === 0) {
    container.appendChild(createNoteSection());
  } else {
    page.sections.forEach(section => {
      container.appendChild(createNoteSection(
        section.title || '',
        section.content || '',
        section.images || []
      ));
    });
  }
}

function updatePageNavigation() {
  const indicator = document.getElementById('pageIndicator');
  const titleInput = document.getElementById('pageTitleInput');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  
  if (indicator) {
    indicator.textContent = `${currentNotePage + 1}/${notePages.length}`;
  }
  
  if (titleInput && notePages.length > 0) {
    titleInput.value = notePages[currentNotePage].title || `ãƒšãƒ¼ã‚¸ ${currentNotePage + 1}`;
  }
  
  if (prevBtn) {
    prevBtn.disabled = currentNotePage === 0;
    prevBtn.style.opacity = currentNotePage === 0 ? '0.5' : '1';
  }
  
  if (nextBtn) {
    nextBtn.disabled = currentNotePage >= notePages.length - 1;
    nextBtn.style.opacity = currentNotePage >= notePages.length - 1 ? '0.5' : '1';
  }
}

function updateStatus(msg) {
  const el = document.getElementById('saveStatus');
  if (el) el.textContent = msg;
}

// ===== ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ =====
function createNoteSection(title = '', content = '', images = []) {
  const section = document.createElement('div');
  section.className = 'note-section';
  section.draggable = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯
  
  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒ«
  const header = document.createElement('div');
  header.className = 'note-section-header';
  
  const dragHandle = document.createElement('span');
  dragHandle.textContent = 'â‰¡';
  dragHandle.className = 'drag-handle';
  dragHandle.style.cssText = 'cursor:grab;margin-right:8px;color:rgba(255,255,255,0.6);font-size:18px;padding:4px 8px;user-select:none;';
  
  // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã§ã®ã¿ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
  dragHandle.addEventListener('mousedown', () => {
    section.draggable = true;
  });
  
  dragHandle.addEventListener('mouseup', () => {
    section.draggable = false;
  });
  
  const titleWrapper = document.createElement('div');
  titleWrapper.className = 'note-section-title-wrapper';
  
  const titleInput = document.createElement('input');
  titleInput.type = 'text';
  titleInput.className = 'note-section-title';
  titleInput.placeholder = 'é …ç›®ã‚¿ã‚¤ãƒˆãƒ«';
  titleInput.value = title;
  titleInput.addEventListener('input', () => scheduleAutoSave());
  
  titleWrapper.appendChild(titleInput);
  
  // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
  const btnContainer = document.createElement('div');
  btnContainer.style.cssText = 'display:flex;gap:4px;margin-left:auto;';
  
  const upBtn = document.createElement('button');
  upBtn.textContent = 'â†‘';
  upBtn.className = 'page-nav-btn';
  upBtn.style.padding = '4px 8px';
  upBtn.addEventListener('click', () => {
    const prev = section.previousElementSibling;
    if (prev) {
      section.parentNode.insertBefore(section, prev);
      scheduleAutoSave();
    }
  });
  
  const downBtn = document.createElement('button');
  downBtn.textContent = 'â†“';
  downBtn.className = 'page-nav-btn';
  downBtn.style.padding = '4px 8px';
  downBtn.addEventListener('click', () => {
    const next = section.nextElementSibling;
    if (next) {
      section.parentNode.insertBefore(next, section);
      scheduleAutoSave();
    }
  });
  
  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'note-section-delete';
  deleteBtn.textContent = 'Ã—';
  deleteBtn.addEventListener('click', () => {
    if (confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      section.remove();
      scheduleAutoSave();
    }
  });
  
  btnContainer.append(upBtn, downBtn, deleteBtn);
  header.append(dragHandle, titleWrapper, btnContainer);
  
  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  const contentArea = document.createElement('textarea');
  contentArea.className = 'note-section-content';
  contentArea.placeholder = 'å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...';
  contentArea.value = content;
  contentArea.addEventListener('input', () => scheduleAutoSave());
  
  // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠ
  const imageContainer = document.createElement('div');
  imageContainer.className = 'note-section-images';
  
  // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
  const dropZone = document.createElement('div');
  dropZone.className = 'drop-zone';
  dropZone.textContent = 'ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ';
  
  // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';
  fileInput.multiple = true;
  
  dropZone.addEventListener('click', () => fileInput.click());
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });
  
  dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    for (const file of files) {
      await addImageToSection(imageContainer, file, dropZone);
    }
  });
  
  fileInput.addEventListener('change', async () => {
    for (const file of fileInput.files) {
      await addImageToSection(imageContainer, file, dropZone);
    }
    fileInput.value = '';
  });
  
  // ã¾ãšdropZoneã¨fileInputã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
  imageContainer.appendChild(dropZone);
  imageContainer.appendChild(fileInput);
  
  // æ—¢å­˜ç”»åƒã‚’è¡¨ç¤ºï¼ˆdropZoneè¿½åŠ å¾Œã«å®Ÿè¡Œï¼‰
  images.forEach(imageData => {
    addExistingImage(imageContainer, imageData, dropZone);
  });
  
  section.append(header, contentArea, imageContainer);
  
  // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
  setupSectionDrag(section);
  
  return section;
}

function setupSectionDrag(section) {
  section.addEventListener('dragstart', (e) => {
    // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰é–‹å§‹ã•ã‚ŒãŸå ´åˆã®ã¿è¨±å¯
    if (!section.draggable) {
      e.preventDefault();
      return;
    }
    section.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  
  section.addEventListener('dragend', () => {
    section.classList.remove('dragging');
    section.draggable = false; // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
    scheduleAutoSave();
  });
  
  section.addEventListener('dragover', (e) => {
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    if (dragging && dragging !== section) {
      const rect = section.getBoundingClientRect();
      const mid = rect.top + rect.height / 2;
      if (e.clientY < mid) {
        section.parentNode.insertBefore(dragging, section);
      } else {
        section.parentNode.insertBefore(dragging, section.nextSibling);
      }
    }
  });
}

// ===== ç”»åƒå‡¦ç† =====
async function addImageToSection(container, file, dropZone) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = async (e) => {
      const base64 = e.target.result;
      const hash = await generateImageHash(base64);
      
      // IndexedDBã«ä¿å­˜
      await saveImageToIndexedDB(hash, base64);
      
      // ã‚µãƒ ãƒã‚¤ãƒ«ä½œæˆ
      const thumb = createImageThumbnail(base64, hash, container);
      container.insertBefore(thumb, dropZone);
      
      scheduleAutoSave();
      resolve();
    };
    reader.readAsDataURL(file);
  });
}

function addExistingImage(container, imageData, dropZone) {
  const thumb = document.createElement('div');
  thumb.className = 'note-image-thumb';
  
  const img = document.createElement('img');
  
  let imageHash = null;
  
  if (typeof imageData === 'string') {
    if (imageData.startsWith('data:')) {
      img.src = imageData;
    } else {
      return; // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—
    }
  } else if (imageData.type === 'hash') {
    imageHash = imageData.value;
    img.dataset.imagehash = imageHash;
    
    // IndexedDBã‹ã‚‰å–å¾—
    getImageFromIndexedDB(imageHash).then(base64 => {
      if (base64) {
        img.src = base64;
      } else {
        img.src = `/api/note-image/${imageHash}`;
      }
    });
  } else if (imageData.type === 'base64') {
    img.src = imageData.value;
  }
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Ã—';
  deleteBtn.style.cssText = 'position:absolute;top:0;right:0;background:rgba(0,0,0,0.7);color:#fff;border:none;width:20px;height:20px;cursor:pointer;display:none;';
  
  thumb.addEventListener('mouseenter', () => deleteBtn.style.display = 'block');
  thumb.addEventListener('mouseleave', () => deleteBtn.style.display = 'none');
  
  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (imageHash) deleteImageFromIndexedDB(imageHash);
    thumb.remove();
    scheduleAutoSave();
  });
  
  // ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§
  thumb.addEventListener('click', () => showImageModal(img.src));
  
  thumb.append(img, deleteBtn);
  container.insertBefore(thumb, dropZone);
}

function createImageThumbnail(base64, hash, container) {
  const thumb = document.createElement('div');
  thumb.className = 'note-image-thumb';
  
  const img = document.createElement('img');
  img.src = base64;
  img.dataset.imagehash = hash;
  
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Ã—';
  deleteBtn.style.cssText = 'position:absolute;top:0;right:0;background:rgba(0,0,0,0.7);color:#fff;border:none;width:20px;height:20px;cursor:pointer;display:none;';
  
  thumb.addEventListener('mouseenter', () => deleteBtn.style.display = 'block');
  thumb.addEventListener('mouseleave', () => deleteBtn.style.display = 'none');
  
  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    deleteImageFromIndexedDB(hash);
    thumb.remove();
    scheduleAutoSave();
  });
  
  thumb.addEventListener('click', () => showImageModal(base64));
  
  thumb.append(img, deleteBtn);
  return thumb;
}

function showImageModal(src) {
  const modal = document.createElement('div');
  modal.className = 'image-modal';
  
  const img = document.createElement('img');
  img.src = src;
  
  modal.appendChild(img);
  modal.addEventListener('click', () => modal.remove());
  document.body.appendChild(modal);
}

async function generateImageHash(base64Data) {
  try {
    const data = base64Data.split(',')[1] || base64Data;
    const bytes = Uint8Array.from(atob(data), c => c.charCodeAt(0));
    
    if (crypto && crypto.subtle) {
      const hashBuffer = await crypto.subtle.digest('SHA-256', bytes);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    let hash = 0;
    for (let i = 0; i < bytes.length; i++) {
      hash = ((hash << 5) - hash) + bytes[i];
      hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
  } catch (e) {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
}

// ===== ãƒšãƒ¼ã‚¸æ“ä½œ =====
function getCurrentPageSections() {
  const sections = [];
  const container = document.getElementById('noteSectionsContainer');
  
  container.querySelectorAll('.note-section').forEach(sectionEl => {
    const title = sectionEl.querySelector('.note-section-title')?.value || '';
    const content = sectionEl.querySelector('.note-section-content')?.value || '';
    const images = [];
    
    sectionEl.querySelectorAll('.note-image-thumb img').forEach(img => {
      if (img.dataset.imagehash) {
        images.push({ type: 'hash', value: img.dataset.imagehash });
      } else if (img.src.startsWith('data:')) {
        images.push({ type: 'base64', value: img.src });
      }
    });
    
    sections.push({ title, content, images });
  });
  
  return sections;
}

function switchToPage(index) {
  if (index < 0 || index >= notePages.length) return;
  
  // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
  notePages[currentNotePage].sections = getCurrentPageSections();
  
  currentNotePage = index;
  localStorage.setItem('tv_note_current_page', currentNotePage);
  
  updatePageNavigation();
  loadCurrentPage();
}

function addNewPage() {
  // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
  notePages[currentNotePage].sections = getCurrentPageSections();
  
  const newId = Math.max(...notePages.map(p => p.id)) + 1;
  notePages.push({
    id: newId,
    title: `ãƒšãƒ¼ã‚¸ ${notePages.length + 1}`,
    sections: [],
    lastModified: new Date().toISOString()
  });
  
  currentNotePage = notePages.length - 1;
  updatePageNavigation();
  loadCurrentPage();
  scheduleAutoSave();
}

function deletePage() {
  if (notePages.length <= 1) {
    alert('æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
    return;
  }
  
  if (!confirm('ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  
  notePages.splice(currentNotePage, 1);
  currentNotePage = Math.min(currentNotePage, notePages.length - 1);
  
  updatePageNavigation();
  loadCurrentPage();
  scheduleAutoSave();
}

// ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ =====
function setupEventHandlers() {
  // é …ç›®è¿½åŠ 
  document.getElementById('addNoteSection')?.addEventListener('click', () => {
    const container = document.getElementById('noteSectionsContainer');
    container.appendChild(createNoteSection());
    scheduleAutoSave();
  });
  
  // ä¿å­˜
  document.getElementById('saveNote')?.addEventListener('click', () => saveNotePages());
  
  // å‡ºåŠ›
  document.getElementById('exportNote')?.addEventListener('click', exportNotes);
  
  // èª­è¾¼
  document.getElementById('importNote')?.addEventListener('click', importNotes);
  
  // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  document.getElementById('prevPage')?.addEventListener('click', () => {
    if (currentNotePage > 0) switchToPage(currentNotePage - 1);
  });
  
  document.getElementById('nextPage')?.addEventListener('click', () => {
    if (currentNotePage < notePages.length - 1) switchToPage(currentNotePage + 1);
  });
  
  document.getElementById('addPage')?.addEventListener('click', addNewPage);
  document.getElementById('deletePage')?.addEventListener('click', deletePage);
  
  // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«
  document.getElementById('pageTitleInput')?.addEventListener('input', (e) => {
    if (notePages[currentNotePage]) {
      notePages[currentNotePage].title = e.target.value;
      scheduleAutoSave();
    }
  });
  
  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
  document.getElementById('noteFontSizeSelect')?.addEventListener('change', (e) => {
    const size = e.target.value + 'px';
    document.querySelectorAll('.note-section-content').forEach(el => {
      el.style.fontSize = size;
    });
    localStorage.setItem('tv_note_font_size', e.target.value);
  });
}

function restoreFontSize() {
  const saved = localStorage.getItem('tv_note_font_size');
  if (saved) {
    const select = document.getElementById('noteFontSizeSelect');
    if (select) select.value = saved;
    document.querySelectorAll('.note-section-content').forEach(el => {
      el.style.fontSize = saved + 'px';
    });
  }
}

// ===== è‡ªå‹•ä¿å­˜ =====
function scheduleAutoSave() {
  if (autoSaveTimer) clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    saveNotePages();
  }, 2000);
}

// ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ =====
async function exportNotes() {
  updateStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæº–å‚™ä¸­...');
  
  // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
  notePages[currentNotePage].sections = getCurrentPageSections();
  
  // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’base64ã«å¤‰æ›ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const exportData = [];
  
  for (const page of notePages) {
    const exportPage = {
      id: page.id,
      title: page.title,
      lastModified: page.lastModified,
      sections: []
    };
    
    for (const section of (page.sections || [])) {
      const exportSection = {
        title: section.title,
        content: section.content,
        images: []
      };
      
      // ç”»åƒã‚’base64ã«å¤‰æ›
      for (const imageData of (section.images || [])) {
        try {
          if (imageData.type === 'base64') {
            exportSection.images.push({ type: 'base64', value: imageData.value });
          } else if (imageData.type === 'hash') {
            // IndexedDBã‹ã‚‰å–å¾—ã—ã¦base64ã«å¤‰æ›
            const base64 = await getImageFromIndexedDB(imageData.value);
            if (base64) {
              exportSection.images.push({ type: 'base64', value: base64 });
            }
          } else if (typeof imageData === 'string' && imageData.startsWith('data:')) {
            exportSection.images.push({ type: 'base64', value: imageData });
          }
        } catch (e) {
          console.warn('[EXPORT] Failed to export image:', e);
        }
      }
      
      exportPage.sections.push(exportSection);
    }
    
    exportData.push(exportPage);
  }
  
  const data = JSON.stringify(exportData, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `notes_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  updateStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
}

function importNotes() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.addEventListener('change', async () => {
    const file = input.files[0];
    if (!file) return;
    
    try {
      updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
      const text = await file.text();
      console.log('[IMPORT] File content length:', text.length);
      
      let data;
      try {
        data = JSON.parse(text);
      } catch (parseError) {
        console.error('[IMPORT] JSON parse error:', parseError);
        alert('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + parseError.message);
        updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—');
        return;
      }
      
      console.log('[IMPORT] Parsed data:', typeof data, Array.isArray(data) ? data.length : 'not array');
      
      if (!Array.isArray(data)) {
        alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
        updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—');
        return;
      }
      
      if (data.length === 0) {
        alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
        updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—');
        return;
      }
      
      // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ¤œè¨¼ãƒ»æ­£è¦åŒ–
      const normalizedPages = data.map((page, idx) => ({
        id: page.id || idx + 1,
        title: page.title || `ãƒšãƒ¼ã‚¸ ${idx + 1}`,
        sections: (page.sections || []).map(section => ({
          title: section.title || '',
          content: section.content || '',
          images: (section.images || []).map(img => {
            if (typeof img === 'string') {
              return { type: 'base64', value: img };
            } else if (img.type && img.value) {
              return img;
            }
            return null;
          }).filter(Boolean)
        })),
        lastModified: page.lastModified || new Date().toISOString()
      }));
      
      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      showImportOptionsDialog(normalizedPages);
      
    } catch (e) {
      console.error('[NOTE WINDOW] Import error:', e);
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—');
    }
  });
  
  input.click();
}

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function showImportOptionsDialog(importedPages) {
  // æ—¢å­˜ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã‚ã‚Œã°å‰Šé™¤
  const existingDialog = document.getElementById('importOptionsDialog');
  if (existingDialog) existingDialog.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'importOptionsDialog';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
  
  const dialog = document.createElement('div');
  dialog.style.cssText = 'background:#3a3a4a;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:20px;min-width:300px;max-width:400px;';
  
  dialog.innerHTML = `
    <h3 style="margin:0 0 16px 0;color:#f5f7ff;font-size:16px;">èª­è¾¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
    <p style="color:rgba(255,255,255,0.8);font-size:13px;margin-bottom:16px;">
      ${importedPages.length}ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
      ã©ã®ã‚ˆã†ã«å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ
    </p>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <button id="importReplace" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:10px;cursor:pointer;">
        å®Œå…¨ç½®æ›<br><small style="opacity:0.7;">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ç½®ãæ›ãˆ</small>
      </button>
      <button id="importMerge" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:10px;cursor:pointer;">
        ãƒãƒ¼ã‚¸è¿½åŠ <br><small style="opacity:0.7;">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã®å¾Œã«è¿½åŠ </small>
      </button>
      <button id="importPreview" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:10px;cursor:pointer;">
        ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º<br><small style="opacity:0.7;">å†…å®¹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ±ºå®š</small>
      </button>
      <button id="importCancel" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:10px;cursor:pointer;margin-top:8px;">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>
  `;
  
  overlay.appendChild(dialog);
  document.body.appendChild(overlay);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  document.getElementById('importReplace').addEventListener('click', async () => {
    overlay.remove();
    await executeImport(importedPages, 'replace');
  });
  
  document.getElementById('importMerge').addEventListener('click', async () => {
    overlay.remove();
    await executeImport(importedPages, 'merge');
  });
  
  document.getElementById('importPreview').addEventListener('click', () => {
    overlay.remove();
    showImportPreview(importedPages);
  });
  
  document.getElementById('importCancel').addEventListener('click', () => {
    overlay.remove();
    updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  });
  
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
      updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
    }
  });
}

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
async function executeImport(importedPages, mode) {
  try {
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
    notePages[currentNotePage].sections = getCurrentPageSections();
    
    if (mode === 'replace') {
      notePages = importedPages;
      currentNotePage = 0;
    } else if (mode === 'merge') {
      // IDã‚’å†å‰²ã‚Šå½“ã¦ã—ã¦è¿½åŠ 
      const maxId = Math.max(...notePages.map(p => p.id), 0);
      importedPages.forEach((page, idx) => {
        page.id = maxId + idx + 1;
      });
      notePages = [...notePages, ...importedPages];
    }
    
    updatePageNavigation();
    loadCurrentPage();
    await saveNotePages();
    updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ${mode === 'replace' ? 'ç½®æ›' : 'ãƒãƒ¼ã‚¸'}ï¼š${importedPages.length}ãƒšãƒ¼ã‚¸ï¼‰`);
  } catch (e) {
    console.error('[IMPORT] Execute error:', e);
    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + e.message);
    updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—');
  }
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
function showImportPreview(importedPages) {
  const existingPreview = document.getElementById('importPreviewDialog');
  if (existingPreview) existingPreview.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'importPreviewDialog';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
  
  const dialog = document.createElement('div');
  dialog.style.cssText = 'background:#3a3a4a;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:20px;width:80%;max-width:600px;max-height:80%;display:flex;flex-direction:column;';
  
  let previewHtml = `
    <h3 style="margin:0 0 16px 0;color:#f5f7ff;font-size:16px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ${importedPages.length}ãƒšãƒ¼ã‚¸ï¼‰</h3>
    <div style="flex:1;overflow-y:auto;margin-bottom:16px;background:rgba(0,0,0,0.2);border-radius:4px;padding:12px;">
  `;
  
  importedPages.forEach((page, pageIdx) => {
    previewHtml += `
      <div style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.1);">
        <div style="font-weight:600;color:#f5f7ff;margin-bottom:8px;">ğŸ“„ ${page.title || 'ãƒšãƒ¼ã‚¸ ' + (pageIdx + 1)}</div>
    `;
    
    (page.sections || []).forEach((section, secIdx) => {
      const contentPreview = (section.content || '').substring(0, 100) + ((section.content || '').length > 100 ? '...' : '');
      const imageCount = (section.images || []).length;
      previewHtml += `
        <div style="margin-left:16px;margin-bottom:6px;font-size:13px;color:rgba(255,255,255,0.8);">
          <span style="color:#667eea;">â–¸</span> ${section.title || '(ç„¡é¡Œ)'} 
          ${imageCount > 0 ? `<span style="color:#22c55e;">[ç”»åƒ${imageCount}æš]</span>` : ''}
          <div style="margin-left:16px;color:rgba(255,255,255,0.5);font-size:12px;">${contentPreview || '(å†…å®¹ãªã—)'}</div>
        </div>
      `;
    });
    
    previewHtml += `</div>`;
  });
  
  previewHtml += `</div>`;
  
  previewHtml += `
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="previewReplace" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:8px 16px;cursor:pointer;">å®Œå…¨ç½®æ›</button>
      <button id="previewMerge" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:8px 16px;cursor:pointer;">ãƒãƒ¼ã‚¸è¿½åŠ </button>
      <button id="previewCancel" class="btn" style="background:rgba(0,0,0,0.6);color:#fff;border:1px solid #fff;padding:8px 16px;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  `;
  
  dialog.innerHTML = previewHtml;
  overlay.appendChild(dialog);
  document.body.appendChild(overlay);
  
  document.getElementById('previewReplace').addEventListener('click', async () => {
    overlay.remove();
    await executeImport(importedPages, 'replace');
  });
  
  document.getElementById('previewMerge').addEventListener('click', async () => {
    overlay.remove();
    await executeImport(importedPages, 'merge');
  });
  
  document.getElementById('previewCancel').addEventListener('click', () => {
    overlay.remove();
    updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  });
  
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
      updateStatus('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
    }
  });
}

// ===== ãƒ†ãƒ¼ãƒç®¡ç† =====
function initTheme() {
  // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå›ºå®š
  document.body.className = '';
}

function applyTheme(themeName) {
  // å›ºå®šãƒ†ãƒ¼ãƒã®ãŸã‚ä½•ã‚‚ã—ãªã„
}

function getThemeDisplayName(themeValue) {
  return 'ãƒ€ãƒ¼ã‚¯';
}

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹å‰ã«ä¿å­˜
window.addEventListener('beforeunload', () => {
  notePages[currentNotePage].sections = getCurrentPageSections();
  // åŒæœŸçš„ã«ä¿å­˜ã¯ã§ããªã„ã®ã§ã€æœ€å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«ä¸€æ™‚ä¿å­˜
  localStorage.setItem('tv_note_pages_backup', JSON.stringify(notePages));
});
  </script>
</body>
</html>
