"""
====================================================================================
🚨 本番環境のデータ問題 - 診断結果と解決方法
====================================================================================

【問題の状況】
❌ リロードすると11:15の状態に戻る (ブラウザキャッシュ問題)
❌ 1H、4H、Dのダウ転と突破数が合っていない
❌ ポンド円などが全て上昇を示している (古いデータ)

【診断結果】
データベースを調査した結果、以下のことが判明しました:

1. ✅ USDJPYの5m, 1H, 4H, D: 最新 (17:40頃)
2. ❌ USDJPYの15m: 1月23日09:00で停止
3. ❌ GBPJPY, EURJPY, EURUSD等: 1月23-24日で停止

【根本原因】
TradingViewからのwebhookが届いていない = アラートが停止している可能性

【必要な対応】
====================================================================================

【緊急対応1】TradingViewのアラート状態を確認
-----------------------------------------------------------------------------------
1. TradingView → アラートメニューを開く
2. 各通貨ペアのアラートが「アクティブ」になっているか確認
3. アラートログを確認し、最後に発火した時刻をチェック

注意: TradingViewのアラートは以下の理由で停止することがあります:
  - インジケーターのエラー
  - サーバー側の一時的な問題
  - アラート数の上限に達した
  - プランの有効期限切れ

【緊急対応2】Webhook URLの確認
-----------------------------------------------------------------------------------
TradingViewのアラート設定で、Webhook URLが正しいか確認:
  
  正しいURL: https://tradingview-webhook-s5x1.onrender.com/webhook
  
  ❌ 間違い例:
    - http://... (httpsでない)
    - /webhook が抜けている
    - 古いURL

【緊急対応3】手動でテストwebhookを送信
-----------------------------------------------------------------------------------
以下のコマンドを実行して、サーバーが正常にwebhookを受信できるか確認:

cd TradingViewWebhook
python send_15m_and_two_copies.py

このスクリプトは:
  - USDJPY, EURUSD, GBPUSDの15mデータを送信
  - サーバーが正常に動作しているか確認
  - データベースに正しく保存されるか確認

【対応4】ブラウザキャッシュのクリア (表示問題の解決)
-----------------------------------------------------------------------------------
データベース問題を修正した後:

1. ブラウザで Ctrl + Shift + Delete を押す
2. 「キャッシュされた画像とファイル」にチェック
3. 期間を「全期間」に設定
4. 「データを削除」をクリック
5. Ctrl + F5 でスーパーリロード

【対応5】Renderサーバーの再起動
-----------------------------------------------------------------------------------
Renderのダッシュボードから:
1. Manual Deploy → Clear build cache & deploy
2. または Settings → Restart web service

これにより:
  - サーバーが最新のコードで再起動
  - データベースがクリアされ、新しいデータを受信可能
  - バックアップから復元される (D/4H/1Hのみ)

【TradingViewアラートの再設定手順】
====================================================================================

もしアラートが完全に停止している場合、以下の手順で再設定:

【手順1】現在のアラートを確認
1. TradingView → アラートタブ
2. 各通貨ペア・時間足のアラート状態を確認
3. 非アクティブになっているものをメモ

【手順2】停止しているアラートを削除して再作成
1. 非アクティブなアラートを削除
2. 新しいアラートを作成
3. Webhook URLを設定: https://tradingview-webhook-s5x1.onrender.com/webhook
4. メッセージに正しいJSON形式のデータを設定

【手順3】アラートのテスト
1. 「一度だけ」のテストアラートを作成
2. すぐに発火するように条件を設定
3. webhook_error.logで受信を確認

【確認方法】
====================================================================================

対応後、以下を確認:

1. データベースの最新タイムスタンプを確認:
   python diagnose_db_issue.py

2. ログファイルを監視:
   Get-Content webhook_error.log -Wait -Tail 20

3. ブラウザで表示を確認:
   - F12 → Console
   - タイムスタンプが最新(26日)になっているか
   - ダウ転情報が正しいか

【最悪の場合の対処】
====================================================================================

どうしてもデータが更新されない場合:

1. データベースを完全にクリア:
   python -c "import os; os.remove('TradingViewWebhook/webhook_data.db')"

2. Renderサーバーを再起動

3. TradingViewのアラートを全て再作成

4. テストwebhookを送信して確認

====================================================================================
📞 サポート情報
====================================================================================

この診断結果を保存して、以下を確認してください:
1. TradingViewのアラートログ (最後に発火した時刻)
2. Renderのデプロイログ (エラーが出ていないか)
3. webhook_error.log の最新エントリ

問題が解決しない場合は、上記の情報を提供してください。

生成日時: 2026-01-26 18:03
====================================================================================
"""

print(__doc__)
