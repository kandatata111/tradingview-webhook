=======================================================================
📊 診断結果レポート - USDJPY JSONコード vs 本番DB照合
=======================================================================

【重要な発見】
提供されたJSONコードは本番サーバーに到達していません。

=======================================================================
📅 各時間軸の状況
=======================================================================

1. 日足（D）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ❌ **Webhook未到達** - 最後の受信: 不明（ログなし）
   
   📤 提供されたJSON (time: 1769119200000 = 26/01/23/07:00):
      ダウ転: 下降ダウ
      BOS: -
      ダウ転時間: 26/01/23/07:00
      雲のダウ転: down
      雲のBOS数: 0
      雲のダウ転時間: 26/01/23/07:00
   
   💾 本番DB (timestamp: 26/01/26/16:07):
      ダウ転: 上昇ダウ
      BOS: BOS-3
      ダウ転時間: 25/09/25/06:00
      雲のダウ転: up
      雲のBOS数: 0
      雲のダウ転時間: 25/09/25/06:00
   
   ⚠️ **完全不一致** - JSONのデータがDBに反映されていない

2. 4時間足（240）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✅ **Webhook到達済** - 最後の受信: 26/01/26/16:09:15
   
   📤 提供されたJSON (time: 1769392800000 = 26/01/26/11:00):
      ダウ転: 下降ダウ
      BOS: -
      ダウ転時間: 26/01/23/23:00
      雲のダウ転: down
      雲のBOS数: 0
      雲のダウ転時間: 26/01/23/23:00
   
   💾 本番DB (timestamp: 26/01/26/16:09):
      ダウ転: 下降ダウ ✅
      BOS: - ✅
      ダウ転時間: 26/01/24/04:00 ❌
      雲のダウ転: down ✅
      雲のBOS数: 0 ✅
      雲のダウ転時間: 26/01/24/04:00 ❌
   
   ⚠️ **ダウ転時間のみ不一致** - 16:09受信データが反映、JSONは未到達

3. 1時間足（60）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✅ **Webhook到達済** - 最後の受信: 26/01/26/17:40:10
   
   📤 提供されたJSON (time: 1769414400000 = 26/01/26/17:00):
      ダウ転: 下降ダウ
      BOS: BOS-1
      ダウ転時間: 26/01/23/02:00
      雲のダウ転: down
      雲のBOS数: 0 ← **ここが違う**
      雲のダウ転時間: 26/01/23/02:00
   
   💾 本番DB (timestamp: 26/01/26/17:40):
      ダウ転: 下降ダウ ✅
      BOS: BOS-1 ✅
      ダウ転時間: 26/01/26/16:00 ❌
      雲のダウ転: down ✅
      雲のBOS数: 1 ← **JSONは0、DBは1**
      雲のダウ転時間: 26/01/26/16:00 ❌
   
   ⚠️ **ダウ転時間とBOS数不一致** - 17:40受信データが反映、JSONは未到達

4. 15分足（15）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✅ **Webhook到達済** - 最後の受信: 26/01/26/17:40:01
   
   📤 提供されたJSON (time: 1769418000000 = 26/01/26/18:00):
      ダウ転: 上昇ダウ
      BOS: -
      ダウ転時間: 26/01/26/15:00
      雲のダウ転: up
      雲のBOS数: 0
      雲のダウ転時間: 26/01/26/15:00
   
   💾 本番DB (timestamp: 26/01/23/09:00) ← **3日前！**
      ダウ転: （空）
      BOS: （空）
      ダウ転時間: （空）
      雲のデータなし
   
   📝 17:40に実際に受信したデータ:
      ダウ転: 下降ダウ
      BOS: BOS-1
      ダウ転時間: 26/01/26/16:00
      雲のダウ転: down
      雲のBOS数: 1
      雲のダウ転時間: 26/01/26/16:00
   
   ⚠️ **DBが古いまま** - 17:40のwebhookが保存されていない
                      18:00のJSONは未到達

=======================================================================
🔍 根本原因の分析
=======================================================================

1. **提供されたJSONコードは本番サーバーに到達していません**
   - webhook_log.txtに18:00以降の受信記録なし
   - 提供されたtimeフィールドのunixタイムスタンプがログにない
   - TradingViewからのアラート送信が停止または失敗している

2. **15分足のDB保存が失敗している**
   - 17:40にwebhook受信（ログ確認済）
   - ルール評価も実行（RULE_EVAL_START/END確認済）
   - しかしDBは3日前のデータのまま
   - INSERT OR REPLACEが失敗しているか、別の問題がある

3. **1H、4Hは部分的に更新されている**
   - Webhookは到達してDBも更新されている
   - ただし、提供されたJSONとは内容が異なる（時間差がある）

4. **日足は長期間更新されていない**
   - 最後の受信ログがwebhook_error.logにない
   - DBのタイムスタンプは16:07だが、内容は9月のデータ
   - TradingViewの日足アラートが停止している可能性

=======================================================================
✅ 解決方法
=======================================================================

【緊急対応1】TradingViewアラートの確認
   1. TradingViewを開く
   2. アラートタブで各通貨ペア/時間軸のアラート状態を確認
   3. 特に以下を重点確認:
      - USDJPY 日足アラート: アクティブか？
      - USDJPY 15分足アラート: アクティブか？
      - 最後のトリガー時間は？
   4. Webhook URL が正しいか確認:
      https://tradingview-webhook-s5x1.onrender.com/webhook

【緊急対応2】15分足のDB保存問題を調査
   1. render_server.pyのwebhook処理でエラーが発生していないか確認
   2. SQLiteのINSERT OR REPLACEが正常に動作しているか確認
   3. データベースファイルの権限やロックの問題を確認

【緊急対応3】手動テスト送信
   1. send_15m_and_two_copies.py などのテストスクリプトを実行
   2. DBに正しく保存されるか確認
   3. ログで保存成功メッセージを確認

【緊急対応4】本番サーバーのログ確認
   1. Renderダッシュボードでサーバーログを確認
   2. エラーや例外が発生していないか確認
   3. メモリ不足やタイムアウトの問題がないか確認

=======================================================================
📋 結論
=======================================================================

**インジケーター側のJSONコードは間違っていません。**

問題は以下の2点です:

1. **提供されたJSONコードが本番サーバーに到達していない**
   → TradingViewアラートの送信が失敗しているか、遅延している

2. **15分足のDB保存が失敗している**
   → Webhookは受信しているが、DBへの書き込みが失敗
   → render_server.pyのINSERT処理に問題がある可能性

次のステップ:
1. TradingViewアラートの状態を確認してください
2. 手動でテスト送信を実行して、DB保存が正常か確認してください
3. 15分足のDB保存失敗の原因を特定する必要があります

=======================================================================
